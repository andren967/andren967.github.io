<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Map Text Game</title>
<link href="css/style.css" rel="stylesheet" />
</head>
<body>
<h1>Map Text Game</h1>

<!-- Menu to choose between stages -->
<div id="menu">
    <h2>Select a Stage</h2>
    <label>
        <input type="checkbox" id="testmodeCheckbox" />
        Testmode (skip animations)
    </label>
    <br>
    <button onclick="startPart1()">Start Part 1: Map Game</button>
    <button onclick="startPart2()">Start Part 2: Text Selection</button>
</div>

<!-- Part 1: Map Game -->
<div id="part1" style="display: none;">
    <div class="map-container">
        <!-- The map image will be injected here by JS -->
        <img id="map" alt="Map">
    </div>
    <div class="choices">
        <button onclick="chooseText('Option 1')">ABC</button>
        <button onclick="chooseText('Option 2')">DEF</button>
        <button onclick="chooseText('Option 3')">GHI</button>
    </div>
    <div class="result" id="result"></div>
</div>

<!-- Part 2: Text Selection -->
<div id="part2" style="display: none;">
    <h2>Select Principles</h2>
    <p class="highlightable-text" id="highlightableText">
        <span>The</span> <span>Map</span> <span>Is</span> <span>Not</span> <span>the</span> <span>Territory</span><br><br>
        <span>Maps</span> <span>carry</span> <span>a</span> <span>quiet</span> <span>authority.</span> <span>They</span> <span>settle</span> <span>across</span> <span>pages</span> <span>and</span> <span>walls</span> <span>with</span> <span>an</span> <span>air</span> <span>of</span> <span>finality</span> <span>—</span> <span>lines</span> <span>drawn,</span> <span>names</span> <span>fixed,</span> <span>colours</span> <span>filled</span> <span>in</span> <span>with</span> <span>confidence.</span> <span>But</span> <span>behind</span> <span>that</span> <span>stillness</span> <span>lies</span> <span>a</span> <span>series</span> <span>of</span> <span>choices,</span> <span>many</span> <span>of</span> <span>them</span> <span>invisible,</span> <span>all</span> <span>of</span> <span>them</span> <span>shaping</span> <span>what</span> <span>we</span> <span>think</span> <span>we</span> <span>see.</span><br><br>
        <span>Even</span> <span>the</span> <span>first</span> <span>step</span> <span>is</span> <span>an</span> <span>artful</span> <span>distortion.</span> <span>To</span> <span>lay</span> <span>a</span> <span>round</span> <span>world</span> <span>onto</span> <span>a</span> <span>flat</span> <span>sheet</span> <span>requires</span> <span>compromise,</span> <span>and</span> <span>every</span> <span>projection</span> <span>bends</span> <span>the</span> <span>globe</span> <span>in</span> <span>its</span> <span>own</span> <span>way</span> <span>—</span> <span>stretching</span> <span>poles,</span> <span>compressing</span> <span>continents,</span> <span>pulling</span> <span>one</span> <span>region</span> <span>to</span> <span>the</span> <span>center</span> <span>while</span> <span>another</span> <span>slips</span> <span>toward</span> <span>the</span> <span>edge.</span><br><br>
        <span>What</span> <span>comes</span> <span>next</span> <span>is</span> <span>a</span> <span>language</span> <span>of</span> <span>marks.</span> <span>Shapes</span> <span>and</span> <span>arrows,</span> <span>bars</span> <span>and</span> <span>circles</span> <span>—</span> <span>each</span> <span>one</span> <span>a</span> <span>small</span> <span>act</span> <span>of</span> <span>symbolization</span><span>,</span> <span>carrying</span> <span>meaning</span> <span>beyond</span> <span>its</span> <span>form.</span> <span>They</span> <span>guide</span> <span>the</span> <span>eye,</span> <span>suggest</span> <span>movement</span> <span>or</span> <span>division,</span> <span>imply</span> <span>strength</span> <span>or</span> <span>uncertainty.</span><br><br>
        <span>But</span> <span>no</span> <span>map</span> <span>can</span> <span>contain</span> <span>it</span> <span>all.</span> <span>The</span> <span>world</span> <span>is</span> <span>too</span> <span>complex,</span> <span>too</span> <span>unruly.</span> <span>Through</span> <span>generalization</span><span>,</span> <span>details</span> <span>are</span> <span>swept</span> <span>aside:</span> <span>the</span> <span>bend</span> <span>in</span> <span>the</span> <span>river</span> <span>straightened,</span> <span>the</span> <span>scattering</span> <span>of</span> <span>villages</span> <span>omitted.</span> <span>What's</span> <span>left</span> <span>is</span> <span>not</span> <span>false,</span> <span>but</span> <span>filtered.</span><br><br>
        <span>And</span> <span>when</span> <span>data</span> <span>is</span> <span>involved</span> <span>—</span> <span>numbers,</span> <span>categories,</span> <span>measures</span> <span>—</span> <span>the</span> <span>story</span> <span>is</span> <span>shaped</span> <span>further.</span> <span>Through</span> <span>classification</span><span>,</span> <span>continuous</span> <span>information</span> <span>is</span> <span>sliced</span> <span>into</span> <span>steps</span> <span>and</span> <span>shades,</span> <span>forming</span> <span>patterns</span> <span>that</span> <span>weren’t</span> <span>visible</span> <span>before,</span> <span>or</span> <span>perhaps</span> <span>never</span> <span>existed</span> <span>at</span> <span>all.</span><br><br>
        <span>The</span> <span>sense</span> <span>of</span> <span>importance</span> <span>shifts</span> <span>with</span> <span>distance.</span> <span>Scale</span> <span>is</span> <span>subtle</span> <span>but</span> <span>persuasive;</span> <span>a</span> <span>nation</span> <span>drawn</span> <span>large</span> <span>feels</span> <span>closer,</span> <span>more</span> <span>significant.</span> <span>The</span> <span>same</span> <span>place,</span> <span>reduced</span> <span>on</span> <span>a</span> <span>larger</span> <span>map,</span> <span>might</span> <span>seem</span> <span>a</span> <span>mere</span> <span>footnote</span> <span>to</span> <span>someone</span> <span>else’s</span> <span>story.</span><br><br>
        <span>Of</span> <span>course,</span> <span>what’s</span> <span>visible</span> <span>depends</span> <span>not</span> <span>just</span> <span>on</span> <span>size</span> <span>but</span> <span>on</span> <span>position.</span> <span>Framing and orientation</span> <span>can</span> <span>tilt</span> <span>perception</span> <span>—</span> <span>north</span> <span>doesn’t</span> <span>always</span> <span>sit</span> <span>at</span> <span>the</span> <span>top,</span> <span>and</span> <span>the</span> <span>center</span> <span>is</span> <span>often</span> <span>less</span> <span>a</span> <span>matter</span> <span>of</span> <span>geography</span> <span>than</span> <span>of</span> <span>intent.</span><br><br>
        <span>Even</span> <span>the</span> <span>words</span> <span>matter.</span> <span>A</span> <span>decision</span> <span>has</span> <span>been</span> <span>made</span> <span>about</span> <span>which</span> <span>names</span> <span>appear,</span> <span>how</span> <span>large</span> <span>they</span> <span>are</span> <span>set,</span> <span>and</span> <span>where</span> <span>they</span> <span>sit.</span> <span>Labeling and text placement</span> <span>do</span> <span>more</span> <span>than</span> <span>identify;</span> <span>they</span> <span>elevate,</span> <span>diminish,</span> <span>sometimes</span> <span>erase</span> <span>entirely.</span><br><br>
        <span>And</span> <span>over</span> <span>all</span> <span>of</span> <span>it,</span> <span>colour</span> <span>does</span> <span>its</span> <span>work.</span> <span>A</span> <span>wash</span> <span>of</span> <span>blue</span> <span>can</span> <span>soothe.</span> <span>Red</span> <span>might</span> <span>stir</span> <span>unease.</span> <span>The</span> <span>palette</span> <span>need</span> <span>not</span> <span>be</span> <span>loud</span> <span>to</span> <span>be</span> <span>persuasive</span> <span>—</span> <span>it</span> <span>only</span> <span>needs</span> <span>to</span> <span>be</span> <span>consistent.</span><br><br>
        <span>So</span> <span>while</span> <span>a</span> <span>map</span> <span>may</span> <span>appear</span> <span>factual,</span> <span>it</span> <span>is</span> <span>never</span> <span>neutral.</span> <span>It</span> <span>reflects</span> <span>not</span> <span>just</span> <span>where</span> <span>things</span> <span>are,</span> <span>but</span> <span>how</span> <span>someone,</span> <span>somewhere,</span> <span>wanted</span> <span>them</span> <span>to</span> <span>be</span> <span>seen.</span>
  
    </p>
    <button onclick="finishGame()">Finish</button>
</div>

<!-- Modal for score -->
<div class="modal" id="scoreModal">
    <div class="modal-content">
        <h2>Your Score</h2>
        <p id="scoreText"></p>
        <button onclick="closeScoreModal()">Close</button>
    </div>
</div>

<!-- Modal for story text -->
<div class="modal" id="storyModal">
    <div class="modal-content">
        <p id="storyText">Story text goes here...</p>
        <button onclick="closeModal()">Continue</button>
    </div>
</div>

<!-- Part 3: Principle Stages -->
<div id="part3" style="display: none;">
    <h2 id="part3Title">Stage: Principle</h2>
    <div class="map-container" style="position: relative;">
        <img src="" alt="Map" id="part3Map">
        <div id="mapOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
            <div 
                onclick="selectMapPart('upper-left')" 
                style="position: absolute; top: 0; left: 0; width: 25%; height: 25%; border: 2px solid rgba(255, 0, 0, 0.5); cursor: pointer;">
            </div>
        </div>
    </div>
    <button onclick="nextMap()">Next Map</button>
</div>

<div id="suspicionBarContainer" style="display:none;">
    <label for="suspicionBar">Suspicion</label>
    <div class="suspicion-bar-bg">
        <div id="suspicionBar"></div>
        <span id="suspicionValue">5 / 25</span>
    </div>
    <div id="suspicionChange"></div>
</div>

<div class="modal" id="failureModal" style="display:none;">
    <div class="modal-content">
        <h2>Game Over</h2>
        <p id="failureText">You have failed to maintain the regime's trust. The newsroom falls silent as suspicion closes in.</p>
        <button onclick="returnToMenu()">Return to Main Menu</button>
    </div>
</div>

<!-- Image container-->
 <div id="imagePopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;">
    <img id="popupImg" src="" alt="Enlarged Map" style="max-width:90vw;max-height:90vh;box-shadow:0 0 32px #000;">
</div>

<script>
    let part1TaskIntroShown = false;
    let suspicion = 5;
    const suspicionMax = 25;
    let isFailure = false;
    
    const maps = [
        {
            src: "maps/communist_contagion_map.jpg",
            options: [
                 {
                    text: "The red tide of communism spreads like a disease across Eurasia, infecting nations and undermining global stability. Moscow stands at the heart of this plague, sending its poisonous ideology outward. From Korea to the Balkans, entire regions teeter on the edge of collapse. The free world must act decisively to contain and quarantine this threat before it spreads further. Only vigilance and strength can stop the contagion.",
                    suspicion: 5
                 },
                {
                    text: "Communism continues to expand its influence across Eastern Europe and Asia, reshaping borders and alliances. Moscow’s ideological reach can now be felt in places once considered secure. Several countries have been identified as either aligned with or vulnerable to communist expansion. While containment efforts are underway, the situation remains tense. Clear strategic communication and international cooperation are essential in responding to this development.",
                    suspicion: 2
                },
                {
                    text: "Communist influence has taken hold across large parts of Eastern Europe and Northern Asia, with Moscow at the ideological center. Several neighboring regions exhibit varying degrees of alignment, whether through political pressure, occupation, or ideological sympathy. Strategic areas such as Manchuria, Iran, and Korea show signs of instability or transformation. Tensions continue to mount as ideological boundaries become increasingly visible on the global stage. These developments are shaping a new post-war geopolitical landscape.",
                    suspicion: -2
                }
                ],
            story: "Leona leaned back in her chair, eyes lingering on the headline above the map. She had chosen the middle-ground text—firm, but not alarmist. It felt like the safest path, toeing the line without sounding too eager. As the typesetters took her copy downstairs, she found herself wondering what readers would take from it. Not doubt—just curiosity, a quiet awareness that her words might shape more than she realized. A new folder landed on her desk with a quiet thud—two more maps, and the afternoon had only just begun." 
        },
    {
        src: "maps/thats the spot.jpg",
        options: [
            {
                text: "During the later stages of World War II, strategic attention turned toward Japan’s political and industrial core. Military leadership identified Tokyo as a pivotal objective in the Pacific campaign. The focus on concentrated targets reflected a shift toward swift and decisive action. Civilian support through increased production and logistics was considered vital to sustain military efforts. Public messaging emphasized unity, urgency, and the critical role of the homefront.",
                suspicion: -3
            },
            {
                text: "Victory lies just beyond the horizon—our aim is clear, our will unshakable. With Japan marked as the heart of enemy aggression, the time has come to strike boldly and without hesitation. Admiral Nimitz leads with resolve, pointing us toward decisive triumph. Every bullet, every bomb, every crate of supplies brings us one step closer to justice. Give us the means, and we’ll finish the job.",
                suspicion: 5
            },
            {
                text: "As the war intensifies in the Pacific, strategic focus shifts to the Japanese mainland. Military leaders emphasize the importance of Tokyo as a central hub in the enemy’s operations. Mobilization at home plays a vital role in ensuring success overseas. Supply, production, and resolve are key components in preparing for the next offensive. National unity and commitment remain essential in this phase of the conflict.",
                suspicion: 2
            }
        ],
        story: "Leona tapped the end of her pencil against the desk, staring at the phrase she’d just typed. It was bold—maybe too bold—but it matched the tone the editor would expect. She adjusted a few words, softened one sentence, but kept the resolve intact. The figure in the poster looked sure of himself, and somehow, she felt expected to match that certainty. She hadn’t even filed the piece yet when another rolled-up campaign sheet landed beside her elbow—another image, another message to craft."
    },
    {
        src: "maps/divided_world.jpg",
        options: [
            {
                text: "The world stands divided between freedom and oppression. The Western nations, champions of democracy and strength, must resist the tightening grip of the Eastern bloc. Led by the Soviet Union, the East amasses manpower and arms in preparation for further conquest. Every yellow-shaded region marks a struggle for truth, teetering on the edge of red domination. If the free world does not act, it risks being swallowed whole by the iron hand of Communism.",
                suspicion: 5
            },
            {
                text: "Following World War II, the global balance of power shifted into two dominant spheres. The Soviet Union and its allies represent one bloc, while the United States and Western nations form the other. Several regions remain contested, influenced by both ideologies and post-war restructuring. Military and economic statistics reflect each side's capacity and strategic priorities. These divisions mark a period of geopolitical realignment that would define international relations for decades.",
                suspicion: -5
            },
            {
                text: "Global tensions remain high in the aftermath of the Second World War, as ideological divisions harden between East and West. The Soviet Union continues to expand its influence, while the Western powers work to preserve democratic systems and economic cooperation. Areas in yellow reflect contested regions—zones of political instability and competing interests. Both sides rely on industrial strength and manpower to secure their positions. The future of many nations will likely be shaped by the outcome of these competing worldviews.",
                suspicion: 2
            }
        ],
        story: "Leona read over the numbers twice—population, coal, barrels of oil—all neat and boxed on the page. There was something about this map that felt colder than the others, as though the world had been reduced to colors, factories, and body counts. She didn’t feel uneasy, exactly—just aware of how much rested in how things were framed. With a quiet breath, she typed the final sentence and leaned back. Another map already waited in the out-tray."
    },

    {
    src: "maps/Map_Two Worlds_lowerQuality.png",
    options: [
        {
            text: "By 1950, the global landscape had hardened into two opposing blocs. The Soviet Union expanded its influence over Eastern Europe and parts of Asia, prompting the Western powers to form alliances in response. The ideological divide is clear, and tensions remain high as each side seeks to secure its sphere. Key regions now act as buffers, caught between larger forces. The world watches as balance teeters between confrontation and containment.",
            suspicion: 2
        },
        {
            text: "The post-war geopolitical order of 1950 reflects a division between Soviet-aligned and Western-aligned nations. The U.S.S.R. occupies a significant portion of Eurasia, while the United States and its allies maintain influence across the Atlantic and Pacific spheres. Neutral and contested regions lie between, highlighting the complexity of emerging Cold War alignments. Strategic interests shape alliances, military presence, and foreign policy objectives on both sides. These developments mark a new era in global power relations.",
            suspicion: -5
        },
        {
            text: "The world is now split in two: one side free, the other shackled under communist rule. The Soviet empire stretches its grip across half the globe, spreading its red shadow east and west. Behind the Iron Curtain, truth is suppressed and liberty extinguished. But the United States and its allies stand firm as a barrier to this expansion. This is not just a map—it is a warning.",
            suspicion: 5
        }
    ],
    // No story here; handled in showStory for the last map
}
    ];

    const correctPrinciples = [
                                "projection",
                                "symbolization",
                                "generalization",
                                "classification",
                                "scale",
                                "Framing and orientation",
                                "Labeling and text placement",
                                "colour"];
;
    let selectedWords = [];
    let activePrinciples = [];
    let currentPrincipleIndex = 0;
    let currentMapIndex = 0;

    const mapsPerPrinciple = {
        principles: ["maps/Map_Two Worlds.jpg", "maps/Map2.jpg", "maps/Map3.jpg", "maps/Map4.jpg"],
        honesty: ["maps/Honesty1.jpg", "maps/Honesty2.jpg", "maps/Honesty3.jpg", "maps/Honesty4.jpg"],
        integrity: ["maps/Integrity1.jpg", "maps/Integrity2.jpg", "maps/Integrity3.jpg", "maps/Integrity4.jpg"],
        respect: ["maps/Respect1.jpg", "maps/Respect2.jpg", "maps/Respect3.jpg", "maps/Respect4.jpg"]
    };

    // Global testmode flag
    let testmode = false;

    // Listen for checkbox changes
    document.addEventListener('DOMContentLoaded', function() {
        const checkbox = document.getElementById('testmodeCheckbox');
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                testmode = checkbox.checked;
            });
        }
    });

    function startPart1() {
        document.getElementById('menu').style.display = 'none';
        showPart1IntroPopup();
    }

    function startPart2() {
        document.getElementById('menu').style.display = 'none';
        //document.getElementById('part2').style.display = 'block';
        showPart2IntroPopup();
    }

    function startPart3() {
        document.getElementById('menu').style.display = 'none';
        document.getElementById('part2').style.display = 'none';
        document.getElementById('part3').style.display = 'block';

        // Activate only the correctly selected principles
        activePrinciples = selectedWords.filter(word => correctPrinciples.includes(word));
        if (activePrinciples.length === 0) {
            alert("No principles were selected correctly. Part 3 cannot be started.");
            document.getElementById('menu').style.display = 'block';
            return;
        }

        loadPrincipleStage();
    }

    function loadPrincipleStage() {
        if (currentPrincipleIndex >= activePrinciples.length) {
            alert("You have completed all stages!");
            document.getElementById('part3').style.display = 'none';
            document.getElementById('menu').style.display = 'block';
            return;
        }

        const principle = activePrinciples[currentPrincipleIndex];
        const maps = mapsPerPrinciple[principle];

        if (currentMapIndex >= maps.length) {
            currentPrincipleIndex++;
            currentMapIndex = 0;
            loadPrincipleStage();
            return;
        }

        const mapElement = document.getElementById('part3Map');
        mapElement.src = maps[currentMapIndex];
        document.getElementById('part3Title').textContent = `Stage: ${principle} (Map ${currentMapIndex + 1} of ${maps.length})`;

        // Add specific logic for the "Two Worlds" map
        if (maps[currentMapIndex] === "maps/Map_Two_Worlds.jpg") {
            alert("For this map, select the principle in the upper-left corner.");
        }
    }

    function updateMap() {
        const mapElement = document.getElementById('map');
        const resultElement = document.getElementById('result');
        const buttons = document.querySelectorAll('.choices button');

        // Update the map image dynamically
        mapElement.src = maps[currentMapIndex].src;
        mapElement.alt = "Map " + (currentMapIndex + 1);

        // --- ADD THIS BLOCK HERE ---
        const imagePopup = document.getElementById('imagePopup');
        const popupImg = document.getElementById('popupImg');
        if (mapElement && imagePopup && popupImg) {
            mapElement.style.cursor = "zoom-in";
            // Remove previous click listeners to avoid stacking
            mapElement.onclick = null;
            mapElement.onclick = function() {
                popupImg.src = mapElement.src;
                imagePopup.style.display = 'flex';
            };
            imagePopup.onclick = function() {
                imagePopup.style.display = 'none';
                popupImg.src = "";
            };
        }
        // --- END BLOCK ---

        // Update button text
        maps[currentMapIndex].options.forEach((option, index) => {
        buttons[index].textContent = `Text ${index + 1}: ${option.text}`;
        buttons[index].onclick = () => chooseText(option);
    });

    // Clear the result text
    resultElement.textContent = '';

    if (!part1TaskIntroShown) {
        part1TaskIntroShown = true;
        showPart1TaskIntroPopup();
        return; // Don't run the rest of updateMap until popup is closed
    }
    }

    function chooseText(option) {
        const result = document.getElementById('result');
        /*result.textContent = `You chose: ${option}`;*/

        // Show the suspicion change
        showSuspicionChange(option.suspicion);

        // Suspicion logic
        suspicion += option.suspicion;

        // Clamp suspicion between 0 and suspicionMax
        suspicion = Math.max(0, Math.min(suspicionMax, suspicion));
        updateSuspicionBar();
        showSuspicionChange(option.suspicion); // Show suspicion change

        // Show the story for the current map
        showStory();
    }

    function showStory() {
        const storyModal = document.getElementById('storyModal');
        const storyText = document.getElementById('storyText');

        // Hide choices and map when showing a story
        document.querySelector('.choices').style.display = 'none';
        document.querySelector('.map-container').style.display = 'none';

        // If on the last map, show different story depending on suspicion
        if (currentMapIndex === maps.length - 1) {
            if (suspicion > 20) {
                storyText.innerHTML = `<img src="images/transition1.png" alt="Story Image" style="max-width:100%;margin-bottom:1em;"><br>
                Leona lingered on the glowing red expanse of the Soviet Union, her gaze tracing the exaggerated spread eastward. The hammer and sickle loomed impossibly large, and the curvature of the Earth seemed skewed—like the map was bending truth itself. Why did the West always look smaller, distant, like a fading island on the edge of the globe? She hadn’t noticed such distortions before—but now they leapt out at her. For the first time, she opened her notebook, not to write copy—but to start asking questions.`;
            } else {
                storyText.innerHTML = `<img src="images/game_over1.png" alt="Story Image" style="max-width:100%;margin-bottom:1em;"><br>
                The map was bold, dramatic—just like the others. Leona typed her commentary without hesitation, echoing the same lines she’d learned to use: strength, division, vigilance. She didn’t question the scale, or why some countries seemed stretched while others shrank. She filed her text, straightened her desk, and waited for the next assignment. The maps kept coming, and Leona kept writing—never realizing that she’d become part of the message.`;
                isFailure = true;
            }
        } else {
            const story = maps[currentMapIndex].story || "No story for this map.";
            typewriterEffect(storyText, story, function() {
                // Optionally do something when finished
});
        }

        // Show the modal
        storyModal.style.display = 'flex';

            // If failure, hook into the modal close to show failure screen
        if (isFailure) {
            // Override closeModal for this case
            const originalCloseModal = closeModal;
            closeModal = function() {
                storyModal.style.display = 'none';
                document.getElementById('failureModal').style.display = 'flex';
                // Restore closeModal for future use
                closeModal = originalCloseModal;
            };
        }
    
    }

function closeModal() {
    const storyModal = document.getElementById('storyModal');
    storyModal.style.display = 'none';

    // Show choices and map again if still in part1 and not finished
    if (document.getElementById('part1').style.display !== 'none' && currentMapIndex < maps.length - 1) {
        document.querySelector('.choices').style.display = 'block';
        document.querySelector('.map-container').style.display = 'block';
        currentMapIndex++;
        updateMap();
    } else {
        // End of Part 1, proceed to Part 2
        document.getElementById('part1').style.display = 'none';
        document.getElementById('suspicionBarContainer').style.display = 'none';
        document.getElementById('part2').style.display = 'block';
    }
}

    function selectMapPart() {
        const mapElement = document.getElementById('part3Map');
        const currentMap = mapElement.src;

        // Check if the user is selecting the correct part of the map
        if (currentMap.includes("Map_Two_Worlds.jpg")) {
            alert("You selected the principle in the upper-left corner. Proceeding to the next map...");
        } else {
            alert("You selected a part of the map. Proceeding to the next map...");
        }

        currentMapIndex++;
        loadPrincipleStage();
    }

    // Highlight words in Part 2
document.getElementById('highlightableText').addEventListener('click', function (event) {
    if (event.target.tagName === 'SPAN') {
        event.target.classList.toggle('highlighted');
        const word = event.target.textContent.replace(/[.,!?]/g, ''); // Remove punctuation

        // Remove previous correct/incorrect classes
        event.target.classList.remove('correct', 'incorrect');

        if (event.target.classList.contains('highlighted')) {
            if (correctPrinciples.includes(word)) {
                event.target.classList.add('correct');
            } else {
                event.target.classList.add('incorrect');
            }
            selectedWords.push(word);
        } else {
            selectedWords = selectedWords.filter(item => item !== word);
        }
    }
});

    function finishGame() {
        const correctSelections = selectedWords.filter(word => correctPrinciples.includes(word));
        const incorrectSelections = selectedWords.filter(word => !correctPrinciples.includes(word));
        const score = correctSelections.length - incorrectSelections.length;

        const scoreText = document.getElementById('scoreText');
        scoreText.innerHTML = `
            Correct Selections: ${correctSelections.join(", ")}<br>
            Incorrect Selections: ${incorrectSelections.join(", ")}<br>
            Final Score: ${score}
        `;

        const scoreModal = document.getElementById('scoreModal');
        scoreModal.style.display = 'flex';

        // Automatically start Part 3 if there are correctly selected principles
        if (correctSelections.length > 0) {
            setTimeout(() => {
                closeScoreModal();
                startPart3();
            }, 2000); // Wait 2 seconds before transitioning to Part 3
        } else {
            alert("No correct principles selected. Returning to the menu.");
            document.getElementById('menu').style.display = 'block';
        }
    }

    function closeScoreModal() {
        const scoreModal = document.getElementById('scoreModal');
        scoreModal.style.display = 'none';
    }

    function loadPrincipleStage() {
        if (currentPrincipleIndex >= activePrinciples.length) {
            alert("You have completed all stages!");
            document.getElementById('part3').style.display = 'none';
            document.getElementById('menu').style.display = 'block';
            return;
        }

        const principle = activePrinciples[currentPrincipleIndex];
        const maps = mapsPerPrinciple[principle];

        if (currentMapIndex >= maps.length) {
            currentPrincipleIndex++;
            currentMapIndex = 0;
            loadPrincipleStage();
            return;
        }

        const mapElement = document.getElementById('part3Map');
        mapElement.src = maps[currentMapIndex];
        document.getElementById('part3Title').textContent = `Stage: ${principle} (Map ${currentMapIndex + 1} of ${maps.length})`;

        // Add specific logic for the "Two Worlds" map
        if (maps[currentMapIndex] === "maps/Map_Two_Worlds.jpg") {
            alert("For this map, select the principle in the upper-left corner.");
        }
    }

    function selectMapPart(area) {
        const mapElement = document.getElementById('part3Map');
        const currentMap = mapElement.src;

        if (currentMap.includes("Map_Two_Worlds.jpg") && area === "upper-left") {
            alert("Correct! You selected the principle in the upper-left corner.");
        } else {
            alert("Incorrect selection. Try again.");
        }
    }

    function nextMap() {
        currentMapIndex++;
        loadPrincipleStage();
    }

    function showPart1IntroPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('part1IntroPopup');
        if (oldPopup) oldPopup.remove();

        // Sections and images
        const sections = [
            {
                text: `<strong>Velgravia, 1961.</strong><br>
                A country caught in the tide of ambition, ideology, and unrest. In the capital, where pastel façades peel under the weight of old grandeur, the people turn to the only source they trust: The Sentinel, the nation's most influential newspaper.`,
                img: "images/country.jpg",
                alt: "Velgravia"
            },
            {
                text: `Its headquarters rises like a relic from a brighter era—part cathedral, part fortress. Narrow staircases twist past marble busts of long-dead editors. Linotype machines hammer like clockwork in the belly of the building. Tea is served precisely at five. It smells of ink, brass, and expectation.`,
                img: "images/headquarter.jpg",
                alt: "Headquarter"
            },
            {
                text: `You are <strong>Leona Mirek</strong>, a young journalist fresh out of university, brimming with idealism, ambition—and a deep, enduring love for maps.`,
                img: "images/character.jpg",
                alt: "Leona Mirek"
            },
            {
                text: `<strong>Editor Kessler</strong><span style="font-size:0.95em;"> (leaning on the doorframe, eyes on his watch):</span><br><br>
                <em>“Mirek. You’ve got the map texts now. Simple stuff—just a few lines beneath the graphics. Keep it sharp, patriotic, and don’t get clever. These maps already tell the story—your job is to help the readers see it the right way.<br><br>
                Don’t wander off into nuance. Stick to the message. It’s not your job to ask why or how—just make it sound clear, certain, and important. Just give them a story they can nod along to over their morning coffee. Clear?<br><br>
                First draft on my desk before five.”</em>`,
                img: "images/boss.jpg",
                alt: "Editor Kessler"
            }
        ];

        let sectionIndex = 0;

        // Create the popup overlay
        const introPopup = document.createElement('div');
        introPopup.id = 'part1IntroPopup';
        introPopup.className = 'modal'; // Use your modal CSS for background
        introPopup.innerHTML = `
            <div class="popup-content">
                <div id="typewriterText"></div>
                <img id="introImage" src="" alt="">
                <button id="nextIntroBtn" style="display:none;">Next</button>
            </div>
        `;
        document.body.appendChild(introPopup);

        const typewriterTarget = document.getElementById('typewriterText');
        const introImage = document.getElementById('introImage');
        const nextBtn = document.getElementById('nextIntroBtn');

        function showSection(idx) {
            let localAbort = false; // Local abort flag for this section

            typewriterTarget.innerHTML = "";
            introImage.classList.remove('visible');
            introImage.classList.add('intro-image-fade');
            introImage.style.display = "none";
            nextBtn.style.display = "none";
            const html = sections[idx].text;
            const img = sections[idx].img;
            const alt = sections[idx].alt;

            // Extract <strong> heading if present
            const strongMatch = html.match(/<strong>(.*?)<\/strong><br\s*\/?>/i);
            let heading = "";
            let restHtml = html;
            if (strongMatch) {
                heading = strongMatch[1];
                restHtml = html.replace(/<strong>.*?<\/strong><br\s*\/?>/i, "");
            }

            // Remove previous click listeners by setting onclick to null
            const popupContent = introPopup.querySelector('.popup-content');
            introPopup.onclick = null;
            introPopup.onclick = function(e) {
                // Only abort if the click is not on the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            // Attach abort handler for this section
            introPopup.onclick = function(e) {
                // Prevent abort if clicking the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            if (testmode) {
                if (heading) {
                    typewriterTarget.innerHTML = `<p><strong>${heading}</strong></p>${restHtml}`;
                } else {
                    typewriterTarget.innerHTML = restHtml;
                }
                introImage.src = img;
                introImage.alt = alt;
                introImage.style.display = "block";
                introImage.classList.remove('intro-image-fade', 'visible');
                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                nextBtn.style.display = "inline-block";
            } else {
                setTimeout(() => {
                    introImage.src = img;
                    introImage.alt = alt;
                    introImage.style.display = "block";
                    void introImage.offsetWidth;
                    introImage.classList.add('visible');

                    setTimeout(() => {
                        if (heading) {
                            typewriterTarget.innerHTML = `<p><strong id="typewriterHeading"></strong></p><span id="typewriterRest"></span>`;
                        } else {
                            typewriterTarget.innerHTML = `<span id="typewriterRest"></span>`;
                        }
                        const headingTarget = document.getElementById('typewriterHeading');
                        const restTarget = document.getElementById('typewriterRest');
                        let i = 0, j = 0;

                        // Remove HTML tags from restHtml for typing, preserve line breaks
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = restHtml;
                        const plainRest = tempDiv.textContent || tempDiv.innerText || "";

                        function typeHeading() {
                            if (localAbort) {
                                if (headingTarget) headingTarget.textContent = heading;
                                typeRest(true);
                                return;
                            }
                            if (heading && i < heading.length) {
                                if (headingTarget) headingTarget.textContent += heading.charAt(i);
                                i++;
                                setTimeout(typeHeading, 30);
                            } else {
                                typeRest();
                            }
                        }

                        function typeRest(forceShow) {
                            if (localAbort || forceShow) {
                                restTarget.innerHTML = restHtml;
                                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                nextBtn.style.display = "inline-block";
                                return;
                            }
                            if (j < plainRest.length) {
                                restTarget.textContent += plainRest.charAt(j);
                                j++;
                                setTimeout(() => typeRest(), 30);
                            } else {
                                restTarget.innerHTML = restHtml;
                                setTimeout(() => {
                                    nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                    nextBtn.style.display = "inline-block";
                                }, 200);
                            }
                        }

                        if (heading) {
                            typeHeading();
                        } else {
                            typeRest();
                        }
                    }, 800);
                }, 50);
            }
        }

        nextBtn.onclick = function() {
            sectionIndex++;
            if (sectionIndex < sections.length) {
                showSection(sectionIndex);
            } else {
                introPopup.remove();
                document.getElementById('part1').style.display = 'block';
                updateMap();
            }
        };

        // Show the first section
        showSection(sectionIndex);

    }

    // Show character image popup after intro
    function showCharacterPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('characterPopup');
        if (oldPopup) oldPopup.remove();

        const characterPopup = document.createElement('div');
        characterPopup.id = 'characterPopup';
        characterPopup.style.position = 'fixed';
        characterPopup.style.top = '0';
        characterPopup.style.left = '0';
        characterPopup.style.width = '100vw';
        characterPopup.style.height = '100vh';
        characterPopup.style.background = 'rgba(0,0,0,0.7)';
        characterPopup.style.display = 'flex';
        characterPopup.style.alignItems = 'center';
        characterPopup.style.justifyContent = 'center';
        characterPopup.style.zIndex = '1000';

        characterPopup.innerHTML = `
            <div class="popup-content" style="background:#fff;max-width:400px;padding:2em;border-radius:10px;box-shadow:0 2px 16px #0008;text-align:center;">
                <img src="images/character.jpg" alt="Leona Mirek" style="max-width:100%;height:auto;border-radius:8px;margin-bottom:1em;">
                <div style="font-family:'Special Elite','Source Sans 3',Arial,sans-serif;font-size:1.2em;margin-bottom:1em;">
                    Leona Mirek, young journalist
                </div>
                <button id="closeCharacterBtn" style="margin-top:1em;">OK</button>
            </div>
        `;
        document.body.appendChild(characterPopup);

        document.getElementById('closeCharacterBtn').onclick = function() {
            characterPopup.remove();
            document.getElementById('part1').style.display = 'block';
            updateMap();
        };
    }

    // When the Part 1 button is pressed:
    document.getElementById('part1Btn').onclick = function() {
        showPart1IntroPopup();
        document.getElementById('part1').style.display = 'none'; // Hide task until intro popup is done
    };

    // In showPart1IntroPopup, after the last popup, just show the task:
    nextBtn.onclick = function() {
        sectionIndex++;
        if (sectionIndex < sections.length) {
            showSection(sectionIndex);
        } else {
            introPopup.remove();
            document.getElementById('part1').style.display = 'block';
            updateMap();
        }
    };

    function showPart1TaskIntroPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('part1TaskIntroPopup');
        if (oldPopup) oldPopup.remove();

        // Create the popup overlay
        const popup = document.createElement('div');
        popup.id = 'part1TaskIntroPopup';
        popup.style.position = 'fixed';
        popup.style.top = '0';
        popup.style.left = '0';
        popup.style.width = '100vw';
        popup.style.height = '100vh';
        popup.style.background = 'rgba(0,0,0,0.7)';
        popup.style.display = 'flex';
        popup.style.alignItems = 'center';
        popup.style.justifyContent = 'center';
        popup.style.zIndex = '1000';
        popup.className = 'modal';
        popup.innerHTML = `
            <div class="popup-content" style="max-width: 500px;">
                <p>
                    <strong>Your editor has assigned you to select the accompanying text for today's published map.</strong>
                </p>
                <p>
                    Choose the statement that best reflects the message <strong>The Sentinel</strong> wants to convey.<br>
                    Your words must support the newspaper’s perspective—and by extension, the regime’s.
                </p>
                <p>
                    <em>Be clear. Be confident. Be loyal.</em>
                </p>
                <button id="part1TaskIntroOkBtn">OK</button>
            </div>
        `;
        document.body.appendChild(popup);

        document.getElementById('part1TaskIntroOkBtn').onclick = function() {
            popup.remove();
            document.getElementById('part1').style.display = 'block';
            document.getElementById('suspicionBarContainer').style.display = 'block'; // Show suspicion bar
            updateSuspicionBar(); // <-- Ensure the bar and value are correct
            updateMap();
        };
    }

    // Automatically show Part 1 task intro popup after the character popup
    document.getElementById('closeCharacterBtn').onclick = function() {
        showPart1TaskIntroPopup();
    };

function updateSuspicionBar() {
    const bar = document.getElementById('suspicionBar');
    const val = document.getElementById('suspicionValue');
    const percent = Math.round((suspicion / suspicionMax) * 100);

    // The cover overlays the unfilled part of the bar
    bar.innerHTML = `<div class="suspicion-bar-cover" style="left:${percent}%;width:${100 - percent}%;"></div>`;
    val.textContent = `${suspicion} / ${suspicionMax}`;
}

function showSuspicionChange(amount) {
    const changeDiv = document.getElementById('suspicionChange');
    if (!changeDiv) return;
    changeDiv.textContent = (amount > 0 ? "+" : "") + amount;
    changeDiv.style.color = amount < 0 ? "#b22222" : "#1a7f1a";
    changeDiv.style.opacity = "1";
    changeDiv.style.transform = "translateY(0px)";
    setTimeout(() => {
        changeDiv.style.opacity = "0";
        changeDiv.style.transform = "translateY(-20px)";
    }, 1200);
}

function returnToMenu() {
    // Hide all game sections and modals
    document.getElementById('failureModal').style.display = 'none';
    document.getElementById('scoreModal').style.display = 'none';
    document.getElementById('storyModal').style.display = 'none';
    document.getElementById('part1').style.display = 'none';
    document.getElementById('part2').style.display = 'none';
    document.getElementById('part3').style.display = 'none';
    document.getElementById('suspicionBarContainer').style.display = 'none';
    document.getElementById('menu').style.display = 'block';

    // Remove any intro or character popups if present
    const introPopup = document.getElementById('part1IntroPopup');
    if (introPopup) introPopup.remove();
    const characterPopup = document.getElementById('characterPopup');
    if (characterPopup) characterPopup.remove();
    const part1TaskIntroPopup = document.getElementById('part1TaskIntroPopup');
    if (part1TaskIntroPopup) part1TaskIntroPopup.remove();

    // Reset game state
    currentMapIndex = 0;
    suspicion = 5;
    part1TaskIntroShown = false;
    selectedWords = [];
    activePrinciples = [];
    currentPrincipleIndex = 0;
    isFailure = false;

    // Reset UI elements
    updateSuspicionBar();
    const result = document.getElementById('result');
    if (result) result.textContent = '';
    const choices = document.querySelector('.choices');
    if (choices) choices.style.display = 'block';
    const mapContainer = document.querySelector('.map-container');
    if (mapContainer) mapContainer.style.display = 'block';
}

// Map image enlarge popup logic
document.addEventListener('DOMContentLoaded', function() {
    const mapImg = document.getElementById('map');
    const imagePopup = document.getElementById('imagePopup');
    const popupImg = document.getElementById('popupImg');

    if (mapImg && imagePopup && popupImg) {
        mapImg.style.cursor = "zoom-in";
        mapImg.addEventListener('click', function() {
            popupImg.src = mapImg.src;
            imagePopup.style.display = 'flex';
        });

        imagePopup.addEventListener('click', function() {
            imagePopup.style.display = 'none';
            popupImg.src = "";
        });
    }
});

function typewriterEffect(target, html, callback) {
    // If testmode is enabled, show the text instantly (no animation)
    if (typeof testmode !== "undefined" && testmode) {
        target.innerHTML = html;
        if (callback) callback();
        return;
    }

    // Otherwise, animate the text as before
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    const plain = tempDiv.textContent || tempDiv.innerText || "";

    target.textContent = "";
    let i = 0;
    let localAbort = false;

    // Try to find the closest modal ancestor, fallback to storyModal for legacy code
    let modal = target.closest('.modal') || document.getElementById('storyModal');
    if (!modal) modal = document.body;

    modal.onclick = function(e) {
        if (!e.target.closest('button')) {
            localAbort = true;
        }
    };

    function type() {
        if (localAbort) {
            target.innerHTML = html;
            if (callback) callback();
            modal.onclick = null;
            return;
        }
        if (i < plain.length) {
            target.textContent += plain.charAt(i);
            i++;
            setTimeout(type, 18);
        } else {
            target.innerHTML = html;
            if (callback) callback();
            modal.onclick = null;
        }
    }
    type();
}

function showPart2IntroPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('part2IntroPopup');
        if (oldPopup) oldPopup.remove();

        // Sections and images
        const sections = [
            {
                text: `The newsroom buzzed with the usual rhythm—keys clacking, phones ringing, editors barking headlines across the room. But Leona barely heard it anymore. She stared at the last map she’d commented on, her fingers frozen above the typewriter keys. Something didn’t sit right. The shapes, the colors, the way the lines always seemed to serve the same story—it wasn’t chance.
                    Without a word, she gathered her coat, slipped the map into her satchel, and walked briskly past the archives, avoiding Kessler’s line of sight. Down the stairwell, out through the side entrance, into the wind.
                    An hour later, she stood beneath the vaulted ceiling of the National Library, surrounded by dust and silence. No editor here to steer the narrative—just shelves and shelves of forgotten truths. She wasn’t sure what she was looking for, but she knew where to begin: the maps.
                    And this time, she’d be the one asking the questions.`,
                img: "images/library.jpg",
                alt: "Library"
            },

                        {
                text: `Leona wandered through the dim stacks, her fingers trailing along cracked spines and dust-coated covers. Most titles were dry records—atlases, charts, border archives. She was about to give up when a plain linen book caught her eye.<br><br>
                    <em>“The Language of Maps: Power, Practice, and Perception.”</em><br><br>
                    No author, no markings—just a stamp inside: Restricted, 1930. She opened it carefully. The pages spoke of distortion, symbols, silence, and intent.
                    She leaned against the shelf and kept reading. The maps were starting to make sense—and that frightened her.`,
                img: "images/library_inside.jpg",
                alt: "Library_Inside"
            },
        ];

        let sectionIndex = 0;

        // Create the popup overlay
        const introPopup = document.createElement('div');
        introPopup.id = 'part2IntroPopup';
        introPopup.className = 'modal'; // Use your modal CSS for background
        introPopup.innerHTML = `
            <div class="popup-content">
                <div id="typewriterText"></div>
                <img id="introImage" src="" alt="">
                <button id="nextIntroBtn" style="display:none;">Next</button>
            </div>
        `;
        document.body.appendChild(introPopup);
        introPopup.style.display = "flex";

        const typewriterTarget = document.getElementById('typewriterText');
        const introImage = document.getElementById('introImage');
        const nextBtn = document.getElementById('nextIntroBtn');

        function showSection(idx) {
            let localAbort = false; // Local abort flag for this section

            typewriterTarget.innerHTML = "";
            introImage.classList.remove('visible');
            introImage.classList.add('intro-image-fade');
            introImage.style.display = "none";
            nextBtn.style.display = "none";
            const html = sections[idx].text;
            const img = sections[idx].img;
            const alt = sections[idx].alt;

            // Extract <strong> heading if present
            const strongMatch = html.match(/<strong>(.*?)<\/strong><br\s*\/?>/i);
            let heading = "";
            let restHtml = html;
            if (strongMatch) {
                heading = strongMatch[1];
                restHtml = html.replace(/<strong>.*?<\/strong><br\s*\/?>/i, "");
            }

            // Remove previous click listeners by setting onclick to null
            const popupContent = introPopup.querySelector('.popup-content');
            introPopup.onclick = null;
            introPopup.onclick = function(e) {
                // Only abort if the click is not on the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            // Attach abort handler for this section
            introPopup.onclick = function(e) {
                // Prevent abort if clicking the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            if (testmode) {
                if (heading) {
                    typewriterTarget.innerHTML = `<p><strong>${heading}</strong></p>${restHtml}`;
                } else {
                    typewriterTarget.innerHTML = restHtml;
                }
                introImage.src = img;
                introImage.alt = alt;
                introImage.style.display = "block";
                introImage.classList.remove('intro-image-fade', 'visible');
                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                nextBtn.style.display = "inline-block";
            } else {
                setTimeout(() => {
                    introImage.src = img;
                    introImage.alt = alt;
                    introImage.style.display = "block";
                    void introImage.offsetWidth;
                    introImage.classList.add('visible');

                    setTimeout(() => {
                        if (heading) {
                            typewriterTarget.innerHTML = `<p><strong id="typewriterHeading"></strong></p><span id="typewriterRest"></span>`;
                        } else {
                            typewriterTarget.innerHTML = `<span id="typewriterRest"></span>`;
                        }
                        const headingTarget = document.getElementById('typewriterHeading');
                        const restTarget = document.getElementById('typewriterRest');
                        let i = 0, j = 0;

                        // Remove HTML tags from restHtml for typing, preserve line breaks
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = restHtml;
                        const plainRest = tempDiv.textContent || tempDiv.innerText || "";

                        function typeHeading() {
                            if (localAbort) {
                                if (headingTarget) headingTarget.textContent = heading;
                                typeRest(true);
                                return;
                            }
                            if (heading && i < heading.length) {
                                if (headingTarget) headingTarget.textContent += heading.charAt(i);
                                i++;
                                setTimeout(typeHeading, 30);
                            } else {
                                typeRest();
                            }
                        }

                        function typeRest(forceShow) {
                            if (localAbort || forceShow) {
                                restTarget.innerHTML = restHtml;
                                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                nextBtn.style.display = "inline-block";
                                return;
                            }
                            if (j < plainRest.length) {
                                restTarget.textContent += plainRest.charAt(j);
                                j++;
                                setTimeout(() => typeRest(), 30);
                            } else {
                                restTarget.innerHTML = restHtml;
                                setTimeout(() => {
                                    nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                    nextBtn.style.display = "inline-block";
                                }, 200);
                            }
                        }

                        if (heading) {
                            typeHeading();
                        } else {
                            typeRest();
                        }
                    }, 800);
                }, 50);
            }
        }

        nextBtn.onclick = function() {
            sectionIndex++;
            if (sectionIndex < sections.length) {
                showSection(sectionIndex);
            } else {
                introPopup.remove();
                document.getElementById('part2').style.display = 'block';
            }
        };

        // Show the first section
        showSection(sectionIndex);

    }

</script>
</body>
</html>