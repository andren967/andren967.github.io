<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drawn to Deceive</title>
<link href="css/style.css" rel="stylesheet" />
</head>
<body>
<h1>Drawn to Deceive</h1>

<!-- Title Screen -->
<div id="titleScreen">
    <h1 class="main-title">
        <span class="title-shadow">Drawn to Deceive</span>
        <span class="title-main">Drawn to Deceive</span></span>
    </h1>
    <img src="images/title_screen.png" alt="Drawn to Deceive" id="titleScreenImg">
    <button id="startGameBtn" onclick="handleStartGame()">Start Game</button>
</div>

<!-- Menu to choose between stages -->
<div id="menu" style="display:none;">
    <h2>Main Menu</h2>
    <div id="principleBadges" style="margin:1em 0; text-align:center;"></div>
    <button id="showThankYouBtn" style="display:none; margin-top:1em;" onclick="showThankYouPopup()">View Ending</button>
    <button id="mainStartBtn" onclick="startPart1()" style="margin: 1.5em 0 1em 0; font-size:1.3em;">Start Game</button>
    <!--
    <button id="optionsBtn" onclick="showOptionsPopup()" style="margin-bottom:1em;">Options</button>
    -->
    <button id="startPrinciplesBtn" onclick="startPart2()" style="display:none; margin-bottom:1em; font-size:1.3em;">Re-Run (From Principles Selection)</button>    
</div>

<!-- Part 1: Map Game -->
<div id="part1" style="display: none;">
    <div class="map-container">
        <!-- The map image will be injected here by JS -->
        <img id="map" alt="Map">
    </div>
    <div class="choices">
        <button onclick="chooseText('Option 1')">ABC</button>
        <button onclick="chooseText('Option 2')">DEF</button>
        <button onclick="chooseText('Option 3')">GHI</button>
    </div>
    <div class="result" id="result"></div>
</div>

<!-- Part 2: Text Selection -->
<div id="part2" style="display: none;">
    <h2>Select Principles</h2>
    <p class="highlightable-text" id="highlightableText">
        <span>The</span> <span>Map</span> <span>Is</span> <span>Not</span> <span>the</span> <span>Territory</span><br><br>
        <span>Maps</span> <span>carry</span> <span>a</span> <span>quiet</span> <span>authority.</span> <span>They</span> <span>settle</span> <span>across</span> <span>pages</span> <span>and</span> <span>walls</span> <span>with</span> <span>an</span> <span>air</span> <span>of</span> <span>finality</span> <span>—</span> <span>lines</span> <span>drawn,</span> <span>names</span> <span>fixed,</span> <span>colours</span> <span>filled</span> <span>in</span> <span>with</span> <span>confidence.</span> <span>But</span> <span>behind</span> <span>that</span> <span>stillness</span> <span>lies</span> <span>a</span> <span>series</span> <span>of</span> <span>choices,</span> <span>many</span> <span>of</span> <span>them</span> <span>invisible,</span> <span>all</span> <span>of</span> <span>them</span> <span>shaping</span> <span>what</span> <span>we</span> <span>think</span> <span>we</span> <span>see.</span><br><br>
        <span>Even</span> <span>the</span> <span>first</span> <span>step</span> <span>is</span> <span>an</span> <span>artful</span> <span>distortion.</span> <span>To</span> <span>lay</span> <span>a</span> <span>round</span> <span>world</span> <span>onto</span> <span>a</span> <span>flat</span> <span>sheet</span> <span>requires</span> <span>compromise,</span> <span>and</span> <span>every</span> <span>projection</span> <span>bends</span> <span>the</span> <span>globe</span> <span>in</span> <span>its</span> <span>own</span> <span>way</span> <span>—</span> <span>stretching</span> <span>poles,</span> <span>compressing</span> <span>continents,</span> <span>pulling</span> <span>one</span> <span>region</span> <span>to</span> <span>the</span> <span>center</span> <span>while</span> <span>another</span> <span>slips</span> <span>toward</span> <span>the</span> <span>edge.</span><br><br>
        <span>What</span> <span>comes</span> <span>next</span> <span>is</span> <span>a</span> <span>language</span> <span>of</span> <span>marks.</span> <span>Shapes</span> <span>and</span> <span>arrows,</span> <span>bars</span> <span>and</span> <span>circles</span> <span>—</span> <span>each</span> <span>one</span> <span>a</span> <span>small</span> <span>act</span> <span>of</span> <span>symbolization</span><span>,</span> <span>carrying</span> <span>meaning</span> <span>beyond</span> <span>its</span> <span>form.</span> <span>They</span> <span>guide</span> <span>the</span> <span>eye,</span> <span>suggest</span> <span>movement</span> <span>or</span> <span>division,</span> <span>imply</span> <span>strength</span> <span>or</span> <span>uncertainty.</span><br><br>
        <span>But</span> <span>no</span> <span>map</span> <span>can</span> <span>contain</span> <span>it</span> <span>all.</span> <span>The</span> <span>world</span> <span>is</span> <span>too</span> <span>complex,</span> <span>too</span> <span>unruly.</span> <span>Through</span> <span>generalization</span><span>,</span> <span>details</span> <span>are</span> <span>swept</span> <span>aside:</span> <span>the</span> <span>bend</span> <span>in</span> <span>the</span> <span>river</span> <span>straightened,</span> <span>the</span> <span>scattering</span> <span>of</span> <span>villages</span> <span>omitted.</span> <span>What's</span> <span>left</span> <span>is</span> <span>not</span> <span>false,</span> <span>but</span> <span>filtered.</span><br><br>
        <span>And</span> <span>when</span> <span>data</span> <span>is</span> <span>involved</span> <span>—</span> <span>numbers,</span> <span>categories,</span> <span>measures</span> <span>—</span> <span>the</span> <span>story</span> <span>is</span> <span>shaped</span> <span>further.</span> <span>Through</span> <span>classification</span><span>,</span> <span>continuous</span> <span>information</span> <span>is</span> <span>sliced</span> <span>into</span> <span>steps</span> <span>and</span> <span>shades,</span> <span>forming</span> <span>patterns</span> <span>that</span> <span>weren’t</span> <span>visible</span> <span>before,</span> <span>or</span> <span>perhaps</span> <span>never</span> <span>existed</span> <span>at</span> <span>all.</span><br><br>
        <span>The</span> <span>sense</span> <span>of</span> <span>importance</span> <span>shifts</span> <span>with</span> <span>distance.</span> <span>Scale</span> <span>is</span> <span>subtle</span> <span>but</span> <span>persuasive;</span> <span>a</span> <span>nation</span> <span>drawn</span> <span>large</span> <span>feels</span> <span>closer,</span> <span>more</span> <span>significant.</span> <span>The</span> <span>same</span> <span>place,</span> <span>reduced</span> <span>on</span> <span>a</span> <span>larger</span> <span>map,</span> <span>might</span> <span>seem</span> <span>a</span> <span>mere</span> <span>footnote</span> <span>to</span> <span>someone</span> <span>else’s</span> <span>story.</span><br><br>
        <span>Of</span> <span>course,</span> <span>what’s</span> <span>visible</span> <span>depends</span> <span>not</span> <span>just</span> <span>on</span> <span>size</span> <span>but</span> <span>on</span> <span>position.</span> <span>Framing and orientation</span> <span>can</span> <span>tilt</span> <span>perception</span> <span>—</span> <span>north</span> <span>doesn’t</span> <span>always</span> <span>sit</span> <span>at</span> <span>the</span> <span>top,</span> <span>and</span> <span>the</span> <span>center</span> <span>is</span> <span>often</span> <span>less</span> <span>a</span> <span>matter</span> <span>of</span> <span>geography</span> <span>than</span> <span>of</span> <span>intent.</span><br><br>
        <span>Even</span> <span>the</span> <span>words</span> <span>matter.</span> <span>A</span> <span>decision</span> <span>has</span> <span>been</span> <span>made</span> <span>about</span> <span>which</span> <span>names</span> <span>appear,</span> <span>how</span> <span>large</span> <span>they</span> <span>are</span> <span>set,</span> <span>and</span> <span>where</span> <span>they</span> <span>sit.</span> <span>Labeling and text placement</span> <span>do</span> <span>more</span> <span>than</span> <span>identify;</span> <span>they</span> <span>elevate,</span> <span>diminish,</span> <span>sometimes</span> <span>erase</span> <span>entirely.</span><br><br>
        <span>And</span> <span>over</span> <span>all</span> <span>of</span> <span>it,</span> <span>colour</span> <span>does</span> <span>its</span> <span>work.</span> <span>A</span> <span>wash</span> <span>of</span> <span>blue</span> <span>can</span> <span>soothe.</span> <span>Red</span> <span>might</span> <span>stir</span> <span>unease.</span> <span>The</span> <span>palette</span> <span>need</span> <span>not</span> <span>be</span> <span>loud</span> <span>to</span> <span>be</span> <span>persuasive</span> <span>—</span> <span>it</span> <span>only</span> <span>needs</span> <span>to</span> <span>be</span> <span>consistent.</span><br><br>
        <span>So</span> <span>while</span> <span>a</span> <span>map</span> <span>may</span> <span>appear</span> <span>factual,</span> <span>it</span> <span>is</span> <span>never</span> <span>neutral.</span> <span>It</span> <span>reflects</span> <span>not</span> <span>just</span> <span>where</span> <span>things</span> <span>are,</span> <span>but</span> <span>how</span> <span>someone,</span> <span>somewhere,</span> <span>wanted</span> <span>them</span> <span>to</span> <span>be</span> <span>seen.</span>
  
    </p>
    <button id="finishBtn" onclick="finishGame()" style="margin: 1.5em 0 1em 0; font-size:1.3em;">Finish</button>
</div>

<!-- Modal for score -->
<div class="modal" id="scoreModal">
    <div class="modal-content">
        <p id="scoreText"></p>
        <button onclick="closeScoreModal()">Close</button>
    </div>
</div>

<!-- Modal for story text -->
<div class="modal" id="storyModal">
    <div class="modal-content">
        <p id="storyText">Story text goes here...</p>
        <button onclick="closeModal()">Continue</button>
    </div>
</div>

<!-- Part 3: Principle Stages -->
<div id="part3" style="display: none;">
    <h2 id="part3Title">Stage: Principle</h2>
    <div class="map-container">
        <img src="" alt="Map" id="part3Map">
        <div id="mapOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
            <div 
                onclick="selectMapPart('upper-left')" 
                style="position: absolute; top: 0; left: 0; width: 25%; height: 25%; border: 2px solid rgba(255, 0, 0, 0.5); cursor: pointer;">
            </div>
        </div>
    </div>
    <div id="principleList" style="margin-top:1em;text-align:center;"></div>
</div>

<div id="suspicionBarContainer" style="display:none;">
    <label for="suspicionBar">Suspicion</label>
    <div class="suspicion-bar-bg" style="position:relative;">
        <div id="suspicionBar" style="position:relative; width:110px; height:18px;"></div>
        <div id="suspicionMarker" style="position:absolute;top:0;left:0;height:100%;width:100%;pointer-events:none;"></div>
        <span id="suspicionValue">5 / 25</span>
    </div>
    <div id="suspicionChange"></div>
</div>

<div class="modal" id="failureModal" style="display:none;">
    <div class="modal-content">
        <h2>Game Over</h2>
        <p id="failureText">You have failed to maintain the regime's trust. The newsroom falls silent as suspicion closes in.</p>
        <button onclick="returnToMenu()">Return to Main Menu</button>
    </div>
</div>

<!-- Image container-->
 <div id="imagePopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;">
    <img id="popupImg" src="" alt="Enlarged Map" style="max-width:90vw;max-height:90vh;box-shadow:0 0 32px #000;">
</div>

<script>
    let part1TaskIntroShown = false;
    let suspicion = 5;
    const suspicionMax = 25;
    let isFailure = false;
    
    let typewriterAbort = false;

    let completedPrinciples = [];

    const maps = [
        {
            src: "maps/communist_contagion_map.jpg",
            options: [
                 {
                    text: "The red tide of communism spreads like a disease across Eurasia, infecting nations and undermining global stability. Moscow stands at the heart of this plague, sending its poisonous ideology outward. From Korea to the Balkans, entire regions teeter on the edge of collapse. The free world must act decisively to contain and quarantine this threat before it spreads further. Only vigilance and strength can stop the contagion.",
                    suspicion: 5
                 },
                {
                    text: "Communism continues to expand its influence across Eastern Europe and Asia, reshaping borders and alliances. Moscow’s ideological reach can now be felt in places once considered secure. Several countries have been identified as either aligned with or vulnerable to communist expansion. While containment efforts are underway, the situation remains tense. Clear strategic communication and international cooperation are essential in responding to this development.",
                    suspicion: 2
                },
                {
                    text: "Communist influence has taken hold across large parts of Eastern Europe and Northern Asia, with Moscow at the ideological center. Several neighboring regions exhibit varying degrees of alignment, whether through political pressure, occupation, or ideological sympathy. Strategic areas such as Manchuria, Iran, and Korea show signs of instability or transformation. Tensions continue to mount as ideological boundaries become increasingly visible on the global stage. These developments are shaping a new post-war geopolitical landscape.",
                    suspicion: -2
                }
                ],
            story: `Leona leaned back in her chair, eyes lingering on the headline above the map.<br>
                    She had chosen the middle-ground text—firm, but not alarmist. It felt like the safest path, toeing the line without sounding too eager.<br>
                    As the typesetters took her copy downstairs, she found herself wondering what readers would take from it.<br>
                    Not doubt—just curiosity, a quiet awareness that her words might shape more than she realized.<br>
                    A new folder landed on her desk with a quiet thud—two more maps, and the afternoon had only just begun.
                    `
        },	
    {
        src: "maps/thats the spot.jpg",
        options: [
            {
                text: "During the later stages of World War II, strategic attention turned toward Japan’s political and industrial core. Military leadership identified Tokyo as a pivotal objective in the Pacific campaign. The focus on concentrated targets reflected a shift toward swift and decisive action. Civilian support through increased production and logistics was considered vital to sustain military efforts. Public messaging emphasized unity, urgency, and the critical role of the homefront.",
                suspicion: -3
            },
            {
                text: "Victory lies just beyond the horizon—our aim is clear, our will unshakable. With Japan marked as the heart of enemy aggression, the time has come to strike boldly and without hesitation. Admiral Nimitz leads with resolve, pointing us toward decisive triumph. Every bullet, every bomb, every crate of supplies brings us one step closer to justice. Give us the means, and we’ll finish the job.",
                suspicion: 5
            },
            {
                text: "As the war intensifies in the Pacific, strategic focus shifts to the Japanese mainland. Military leaders emphasize the importance of Tokyo as a central hub in the enemy’s operations. Mobilization at home plays a vital role in ensuring success overseas. Supply, production, and resolve are key components in preparing for the next offensive. National unity and commitment remain essential in this phase of the conflict.",
                suspicion: 2
            }
        ],
        story: `Leona tapped the end of her pencil against the desk, staring at the phrase she’d just typed.It was bold—maybe too bold—but it matched the tone the editor would expect.<br>
                She adjusted a few words, softened one sentence, but kept the resolve intact.The figure in the poster looked sure of himself, and somehow, she felt expected to match that certainty.<br>
                She hadn’t even filed the piece yet when another rolled-up campaign sheet landed beside her elbow—another image, another message to craft.`

    },
    {
        src: "maps/divided_world.jpg",
        options: [
            {
                text: "The world stands divided between freedom and oppression. The Western nations, champions of democracy and strength, must resist the tightening grip of the Eastern bloc. Led by the Soviet Union, the East amasses manpower and arms in preparation for further conquest. Every yellow-shaded region marks a struggle for truth, teetering on the edge of red domination. If the free world does not act, it risks being swallowed whole by the iron hand of Communism.",
                suspicion: 5
            },
            {
                text: "Following World War II, the global balance of power shifted into two dominant spheres. The Soviet Union and its allies represent one bloc, while the United States and Western nations form the other. Several regions remain contested, influenced by both ideologies and post-war restructuring. Military and economic statistics reflect each side's capacity and strategic priorities. These divisions mark a period of geopolitical realignment that would define international relations for decades.",
                suspicion: -5
            },
            {
                text: "Global tensions remain high in the aftermath of the Second World War, as ideological divisions harden between East and West. The Soviet Union continues to expand its influence, while the Western powers work to preserve democratic systems and economic cooperation. Areas in yellow reflect contested regions—zones of political instability and competing interests. Both sides rely on industrial strength and manpower to secure their positions. The future of many nations will likely be shaped by the outcome of these competing worldviews.",
                suspicion: 2
            }
        ],
        story: `Leona read over the numbers twice—population, coal, barrels of oil—all neat and boxed on the page.There was something about this map that felt colder than the others, as though the world had been reduced to colors, factories, and body counts.<br>
                She didn’t feel uneasy, exactly—just aware of how much rested in how things were framed.With a quiet breath, she typed the final sentence and leaned back.
                Another map already waited in the out-tray.`

    },

    {
    src: "maps/Map_Two Worlds_lowerQuality.png",
    options: [
        {
            text: "By 1950, the global landscape had hardened into two opposing blocs. The Soviet Union expanded its influence over Eastern Europe and parts of Asia, prompting the Western powers to form alliances in response. The ideological divide is clear, and tensions remain high as each side seeks to secure its sphere. Key regions now act as buffers, caught between larger forces. The world watches as balance teeters between confrontation and containment.",
            suspicion: 2
        },
        {
            text: "The post-war geopolitical order of 1950 reflects a division between Soviet-aligned and Western-aligned nations. The U.S.S.R. occupies a significant portion of Eurasia, while the United States and its allies maintain influence across the Atlantic and Pacific spheres. Neutral and contested regions lie between, highlighting the complexity of emerging Cold War alignments. Strategic interests shape alliances, military presence, and foreign policy objectives on both sides. These developments mark a new era in global power relations.",
            suspicion: -5
        },
        {
            text: "The world is now split in two: one side free, the other shackled under communist rule. The Soviet empire stretches its grip across half the globe, spreading its red shadow east and west. Behind the Iron Curtain, truth is suppressed and liberty extinguished. But the United States and its allies stand firm as a barrier to this expansion. This is not just a map—it is a warning.",
            suspicion: 5
        }
    ],
    // No story here; handled in showStory for the last map
}
    ];

    const correctPrinciples = [
                                "projection",
                                "symbolization",
                                "generalization",
                                "classification",
                                "Scale",
                                "Framing and orientation",
                                "Labeling and text placement",
                                "colour"];

    const principlesBadges = {
        projection: "badges/projection.jpg",
        symbolization: "badges/symbolization.jpg",
        generalization: "badges/generalization.jpg",
        classification: "badges/classification.jpg",
        Scale: "badges/scale.jpg",
        "Framing and orientation": "badges/framing.jpg",
        "Labeling and text placement": "badges/labeling.jpg",
        colour: "badges/colour.jpg"
    };                            
    

    let selectedWords = [];
    let activePrinciples = [];
    let allCollected = [];
    let currentPrincipleIndex = 0;
    let currentMapIndex = 0;

    const mapsPerPrinciple = {
        projection: ["maps/divided_world.jpg", "maps/colonial_problem.jpg", "maps/Three_faces_of_Europe_1950.jpg", "maps/PJM_2454_01.jpg"],
        symbolization: ["maps/communists_menace_vital_materials.jpg", "maps/concept_of_deterrence.jpg", "maps/east vs west.jpg", "maps/war_against_america.jpg"],
        generalization: ["maps/united_europe_for_peace.jpg", "maps/fifth_column_in_the_south.jpg", "maps/communists_menace_vital_materials.jpg", "maps/communist_contagion_map.jpg"],
        classification: ["maps/communist_contagion_map.jpg", "maps/Defense_of_Europe_1954.jpg", "maps/PJM_2454_01.jpg", "maps/Three_faces_of_Europe_1950.jpg"],
        Scale: ["maps/growth_of_russian_imperialism.jpg", "maps/europe_from_moscow.jpg", "maps/communist_contagion_map.jpg", "maps/Defense_of_Europe_1954.jpg"],
        "Framing and orientation": ["maps/which_is_the_side_of_peace.jpg", "maps/europe_from_moscow.jpg", "maps/thats the spot.jpg", "maps/Asian_rimland_1950.jpg"],
        "Labeling and text placement": ["maps/thats the spot.jpg", "maps/colonial_problem.jpg", "maps/which_is_the_side_of_peace.jpg", "maps/war_against_america.jpg"],
        colour: ["maps/alaska.jpg", "maps/Asian_rimland_1950.jpg", "maps/colonial_problem.jpg", "maps/divided_world.jpg"]
    };

 const mapOverlays = {
    "maps/divided_world.jpg": [
        {
            area: "full-image",
            top: "5%",
            left: "5%",
            width: "90%",
            height: "75%",
            description: "The use of a Mercator projection exaggerates the size of polar regions and stretches Eurasia and the Pacific to wrap around a centered United States. This layout dramatizes America's position as surrounded and under threat from both East and West."
        }
    ],
    "maps/colonial_problem.jpg": [
        {
            area: "eurasia-focus",
            top: "5%",
            left: "5%",
            width: "90%",
            height: "40%",
            description: "The rectangular projection flattens and centers Soviet landmass, while vivid colors segment the colonial world by empire. Bold typographic blocks occupy colonies, making political ownership more prominent than the land itself—subtly reinforcing power hierarchies."
        }
    ],
    "maps/Three_faces_of_Europe_1950.jpg": [
        {
            area: "evolution-slice",
            top: "9%",
            left: "23%",
            width: "55%",
            height: "88%",
            description: "Stacked temporal views use a distorted perspective to exaggerate continuity in threats across decades. Classifying regions under visual regimes (WWI, WWII, Cold War) guides the viewer to draw conclusions about ideological evolution."
        }
    ],
    "maps/PJM_2454_01.jpg": [
        {
            area: "binary-division",
            top: "7%",
            left: "32.5%",
            width: "34%",
            height: "85%",
            description: "The distorted projection emphasizes Soviet and European landmasses while minimizing others. Combined with bold classifications into rigid ideological camps, it reinforces a binary worldview."
        }
    ],
    "maps/communists_menace_vital_materials.jpg": [
        {
            area: "threat-arcs",
            top: "18%",
            left: "45%",
            width: "35%",
            height: "30%",
            description: "Thick black arrows with numbers radiate from the Soviet Union like weapons, labeled with threatening economic commodities. By abstracting regions into numbered 'targets', the map suggests a coordinated campaign without showing any actual events or borders."
        }
    ],
    "maps/concept_of_deterrence.jpg": [
        {
            area: "missile-web",
            top: "20%",
            left: "25%",
            width: "42%",
            height: "48%",
            description: "The web of intersecting missile arcs, planes, and lines visually constructs a narrative of strategic superiority and omnipresent readiness. Symbols replace geography, turning the globe into a stage for conflict, with the U.S. appearing both distant and prepared."
        }
    ],
    "maps/east vs west.jpg": [
        {
            area: "iron-curtain",
            top: "25%",
            left: "25%",
            width: "40%",
            height: "48%",
            description: "Cartoon symbols depict Uncle Sam wheeling Western goods toward barricaded, menaced Eastern Europe, which is patrolled by black beasts. This visual metaphor frames the Cold War not as politics, but as a battle of civilization versus savagery."
        }
    ],
    "maps/war_against_america.jpg": [
        {
            area: "usa-threats",
            top: "30%",
            left: "32%",
            width: "38%",
            height: "15%",
            description: "Here, symbolic clouds and arrows represent abstract threats like propaganda and psychological warfare. The map relies entirely on symbolic visual cues rather than geographic accuracy to deliver its persuasive message."
        }
    ],
    "maps/united_europe_for_peace.jpg": [
        {
            area: "umbrella-europe",
            top: "21.5%",
            left: "35%",
            width: "33%",
            height: "19%",
            description: "The map uses visual symbolism and dramatic simplification, generalizing Europe’s unity under shared values by representing it as a child holding a unified umbrella against a looming red threat, minimizing geographic specifics for narrative clarity."
        }
    ],
    "maps/fifth_column_in_the_south.jpg": [
        {
            area: "southern-us",
            top: "45%",
            left: "28%",
            width: "25%",
            height: "28%",
            description: "Red symbols are scattered loosely over the Southern U.S., suggesting communist infiltration without context. The oversimplified layout equates internal dissent with external threat, generalizing fear across the entire region."
        }
    ],
    "maps/communist_contagion_map.jpg": [
        {
            area: "contagion-zone",
            top: "68%",
            left: "85%",
            width: "14.5%",
            height: "14%",
            description: "This map merges entire nations and regions under broad, stylized labels like “Quarantined” or “Infected.” The exaggerated red mass and uniform stripes across disparate countries simplify geopolitical dynamics into a medical metaphor, using fear to replace nuance."
        }
    ],
    "maps/Defense_of_Europe_1954.jpg": [
        {
            area: "defense-europe",
            top: "40%",
            left: "31%",
            width: "35%",
            height: "60%",
            description: "This map classifies countries into NATO-aligned and enemy zones using stark, flat colors, stripping away complexity in political relationships. The globe’s curvature is exaggerated to compress geographic distances, making Soviet proximity feel more immediate and threatening."
        }
    ],
    "maps/growth_of_russian_imperialism.jpg": [
        {
            area: "shading-expansion",
            top: "9.5%",
            left: "36%",
            width: "43.5%",
            height: "65.5%",
            description: "Territorial expansion is exaggerated through progressive shadings and inset maps. This manipulation of scale makes each phase of Soviet growth seem massive and continuous, invoking a sense of unstoppable advance."
        }
    ],
    "maps/europe_from_moscow.jpg": [
        {
            area: "soviet-horizon",
            top: "37%",
            left: "3%",
            width: "46%",
            height: "37%",
            description: "By presenting Europe and Asia from Moscow’s perspective, the map exaggerates Soviet spatial reach. The tilted orientation and enlarged areas near Russia convey omnipresence, making Western viewers feel surrounded."
        }
    ],
    "maps/which_is_the_side_of_peace.jpg": [
        {
            area: "peace-divide",
            top: "15%",
            left: "12%",
            width: "78%",
            height: "50%",
            description: "The split-screen layout and mirrored geographies invite direct comparison between West and East. Labels and color choices frame the West as open and peaceful, the East as aggressive, urging the viewer to pick a “side.”"
        }
    ],
    "maps/thats the spot.jpg": [
        {
            area: "target-japan",
            top: "20%",
            left: "30%",
            width: "13%",
            height: "16%",
            description: "This poster-style map directs attention toward Japan as a target using concentric circles and bold pointer gesture, while text placement reinforces the message. Framing Tokyo centrally constructs it as the locus of military focus."
        }
    ],
    "maps/alaska.jpg": [
        {
            area: "defensive-alaska",
            top: "33%",
            left: "28%",
            width: "46%",
            height: "40%",
            description: "The use of green tones lends a calm, natural legitimacy to U.S. territory, while darker contrasting shades highlight military presence and infrastructure. This selective color use masks militarization under the appearance of neutral geography."
        }
    ],
    "maps/Asian_rimland_1950.jpg": [
        {
            area: "red-waves",
            top: "3%",
            left: "30%",
            width: "50%",
            height: "38%",
            description: "Red concentric waves radiating from the U.S.S.R. create a sense of creeping influence and expansion. Color contrasts (red vs. green vs. blue) visually encode ideological alliances, suggesting both threat proximity and containment urgency."
        }
    ]
};

const principleStorySnippets = {
    projection: "Leona traced her finger across the stretched-out USSR and frowned. 'They made it look bigger,' she murmured. 'Not just geographically—but ideologically too.'",
    symbolization: "When Leona saw the cartoon clouds marked 'Psychological Warfare,' she chuckled—then stopped. 'It's not geography,' she realized. 'It's fear, dressed up like a map.'",
    generalization: "Looking at the scattered red symbols across the South, Leona whispered, 'It’s not about *where* danger is—it’s that it could be *anywhere*.' The vagueness was the message.",
    classification: "As she studied the neatly color-coded blocs, Leona understood: 'This map doesn’t describe countries—it *sorts* them. Into allies, threats, and nothing in between.'",
    Scale: "With each deeper shade across the Soviet frontier, Leona blinked. 'It’s not just territory,' she thought. 'It’s momentum. Scale makes expansion look *inevitable*.'",
    "Framing and orientation": "Leona tilted her head and saw it—the map’s tilt wasn’t accidental. 'They’ve made the Soviet Union loom,' she said. 'Framing turns position into power.'",
    "Labeling and text placement": "A bold label screamed from the map’s center. Leona leaned in. 'They’ve chosen what we *read* first,' she realized. 'And what we might not see at all.'",
    colour: "Red. So much red. Leona stepped back and saw how the color alone told a story. 'They don’t need to explain,' she muttered. 'The red does the shouting.'"
};

const twoWorldsMapOverlays = [
    {
        principle: "projection",
        area: "central-eurasia",
        top: "1%",
        left: "10%",
        width: "80%",
        height: "63%",
        description: "The curved projection places Eurasia in the center, visually inflating Soviet territory while pushing the Americas to the periphery—intensifying the perception of Soviet dominance and geographic centrality in global conflict."
    },
    {
        principle: "colour",
        area: "east-west-color",
        top: "38%",
        left: "40%",
        width: "10%",
        height: "10%",
        description: "Bold red for the USSR and dark blue for the West visually encode ideological opposition. The aggressive saturation of red evokes danger and urgency, while the cool blues suggest order and alliance."
    },
    {
        principle: "classification",
        area: "bloc-zoning",
        top: "20%",
        left: "20%",
        width: "63%",
        height: "33%",
        description: "Regions are classified into clearly delineated ideological zones using color coding and hatch patterns—‘Soviet-aligned’, ‘Western-aligned’, and ‘contested’—framing the world as a rigid dichotomy."
    },
    {
        principle: "Scale",
        area: "soviet-dominance",
        top: "20%",
        left: "36%",
        width: "47%",
        height: "35%",
        description: "The USSR is visually overrepresented through enlarged landmass and centralized placement, creating an inflated impression of power and reach that may not align with geographic reality."
    },
    {
        principle: "Framing and orientation",
        area: "frame-focus",
        top: "57%",
        left: "4%",
        width: "29.5%",
        height: "42%",
        description: "The globe is tilted to center Eurasia and the Soviet threat, marginalizing the Americas. This orientation places ideological confrontation at the heart of the world, reinforcing urgency and proximity."
    },
    {
        principle: "Labeling and text placement",
        area: "hammer-sickle-label",
        top: "7%",
        left: "6.5%",
        width: "16%",
        height: "12%",
        description: "The bold placement of the phrase 'TWO WORLDS' at the top left serves as a narrative frame for the entire map. Rather than describing geography, the title divides the globe ideologically from the outset, inviting viewers to interpret all visual details through the lens of absolute opposition."
    }, 
    {
        principle: "symbolization",
        area: "visual-cue-region",
        top: "30.5%",
        left: "53.5%",
        width: "9.5%",
        height: "17.5%",
        description: "Military-style hatching and directional shading evoke expansion or influence emanating from the USSR. The use of a large communist emblem reinforces symbolic threat over geographic detail."
    },
    {
        principle: "generalization",
        area: "broad-zones",
        top: "20%",
        left: "15%",
        width: "28%",
        height: "32%",
        description: "Countries are grouped into sweeping color-coded areas, flattening political nuance and ignoring local diversity in favor of a clean East-West binary. Subtleties of allegiance or independence are erased."
    }
];





    // Global testmode flag
    let testmode = false;

    // Listen for checkbox changes
    document.addEventListener('DOMContentLoaded', function() {
        const checkbox = document.getElementById('testmodeCheckbox');
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                testmode = checkbox.checked;
            });
        }
    });

    function startPart1() {
        document.getElementById('menu').style.display = 'none';
        showPart1IntroPopup();
    }

    function startPart2() {
        document.getElementById('menu').style.display = 'none';
        //document.getElementById('part2').style.display = 'block';
        showPart2IntroPopup();
    }

    function startPart3() {
        document.getElementById('menu').style.display = 'none';
        document.getElementById('part2').style.display = 'none';
        document.getElementById('part3').style.display = 'block';

        // If no principles have been selected (e.g. started from menu), use the first 3 correct principles
        if (!activePrinciples || activePrinciples.length === 0) {
            activePrinciples = correctPrinciples.slice(7, 8);
        }

        if (activePrinciples.length === 0) {
            alert("No principles were selected correctly. Part 3 cannot be started.");
            document.getElementById('menu').style.display = 'block';
            return;
        }

        currentPrincipleIndex = 0;
        currentMapIndex = 0;
        loadPrincipleStage();
    }

    function startPart4() {
        // Use the first 3 correct principles for this part
        activePrinciples = correctPrinciples.slice(0, 8);
        /*    activePrinciples = [
        //"projection",
        //"symbolization",
        //"generalization",
        //"classification",
        //"Scale",
        //"Framing and orientation",
        //"Labeling and text placement",
        "colour"
    ];*/
        document.getElementById('menu').style.display = 'none';
        document.getElementById('part3').style.display = 'block';
        showTwoWorldsPrincipleDiscovery(activePrinciples, function() {
            document.getElementById('part3').style.display = 'none';
            document.getElementById('menu').style.display = 'block';
        });
    }

function loadPrincipleStage() {
    if (currentPrincipleIndex >= activePrinciples.length) {
        // Show the final principle story first
        showFinalPrincipleStory(function() {
            // Then start the Two Worlds map game
            showTwoWorldsPrincipleDiscovery(activePrinciples, function() {
                document.getElementById('part3').style.display = 'none';
                document.getElementById('menu').style.display = 'block';
            });
        });
        updatePrincipleList();
        return;
    }

    const principle = activePrinciples[currentPrincipleIndex];
    const maps = mapsPerPrinciple[principle];

    if (currentMapIndex >= maps.length) {
        currentMapIndex = 0; // Reset BEFORE showing the popup
        showPrincipleStoryInput(principle, function(reflection) {
            // Optionally store the reflection here
            currentPrincipleIndex++;
            loadPrincipleStage();
        });
        return;
    }

    const mapElement = document.getElementById('part3Map');
    const mapOverlay = document.getElementById('mapOverlay');
    mapElement.src = maps[currentMapIndex];
    document.getElementById('part3Title').textContent = `Stage: ${principle} (Map ${currentMapIndex + 1} of ${maps.length})`;

    // --- Dynamic overlay logic ---
    // Remove previous overlays
    mapOverlay.innerHTML = "";
    const overlays = mapOverlays[maps[currentMapIndex]];
    if (overlays) {
        overlays.forEach(overlay => {
            const div = document.createElement('div');
            div.className = 'map-overlay-area';
            div.style.top = overlay.top;
            div.style.left = overlay.left;
            div.style.width = overlay.width;
            div.style.height = overlay.height;
            div.onclick = function() {
                // Remove highlight from all overlays first
                Array.from(mapOverlay.children).forEach(child => child.classList.remove('overlay-visible'));
                // Add highlight to this overlay
                div.classList.add('overlay-visible');
                selectMapPart(overlay.area, overlay.description);
            };
            mapOverlay.appendChild(div);
        });
    }
    // ----------------------------

    // Add specific logic for the "Two Worlds" map
    if (maps[currentMapIndex] === "maps/Map_Two_Worlds.jpg") {
        alert("For this map, select the principle in the upper-left corner.");
    }
}

    function updateMap() {
        const mapElement = document.getElementById('map');
        const resultElement = document.getElementById('result');
        const buttons = document.querySelectorAll('.choices button');

        // Update the map image dynamically
        mapElement.src = maps[currentMapIndex].src;
        mapElement.alt = "Map " + (currentMapIndex + 1);

        // --- ADD THIS BLOCK HERE ---
        const imagePopup = document.getElementById('imagePopup');
        const popupImg = document.getElementById('popupImg');
        if (mapElement && imagePopup && popupImg) {
            mapElement.style.cursor = "zoom-in";
            // Remove previous click listeners to avoid stacking
            mapElement.onclick = null;
            mapElement.onclick = function() {
                popupImg.src = mapElement.src;
                imagePopup.style.display = 'flex';
            };
            imagePopup.onclick = function() {
                imagePopup.style.display = 'none';
                popupImg.src = "";
            };
        }
        // --- END BLOCK ---

        // Update button text
        maps[currentMapIndex].options.forEach((option, index) => {
        buttons[index].textContent = `Text ${index + 1}: ${option.text}`;
        buttons[index].onclick = () => chooseText(option);
    });

    // Clear the result text
    resultElement.textContent = '';

    if (!part1TaskIntroShown) {
        part1TaskIntroShown = true;
        showPart1TaskIntroPopup();
        return; // Don't run the rest of updateMap until popup is closed
    }
    }

    function chooseText(option) {
        const result = document.getElementById('result');
        /*result.textContent = `You chose: ${option}`;*/

        // Show the suspicion change
        showSuspicionChange(option.suspicion);

        // Suspicion logic
        suspicion += option.suspicion;

        // Clamp suspicion between 0 and suspicionMax
        suspicion = Math.max(0, Math.min(suspicionMax, suspicion));
        updateSuspicionBar(20);
        showSuspicionChange(option.suspicion); // Show suspicion change

        // Show the story for the current map
        showStory();
    }

    function showStory() {
        const storyModal = document.getElementById('storyModal');
        const storyText = document.getElementById('storyText');

        // Hide choices and map when showing a story
        document.querySelector('.choices').style.display = 'none';
        document.querySelector('.map-container').style.display = 'none';

        // If on the last map, show different story depending on suspicion
        if (currentMapIndex === maps.length - 1) {
            if (suspicion > 20) {
                storyText.innerHTML = `<img src="images/transition1.png" alt="Story Image" style="max-width:100%;margin-bottom:1em;"><br>
                Leona lingered on the glowing red expanse of the Soviet Union, her gaze tracing the exaggerated spread eastward. The hammer and sickle loomed impossibly large, and the curvature of the Earth seemed skewed—like the map was bending truth itself. Why did the West always look smaller, distant, like a fading island on the edge of the globe? She hadn’t noticed such distortions before—but now they leapt out at her. For the first time, she opened her notebook, not to write copy—but to start asking questions.`;
            } else {
                storyText.innerHTML = `<img src="images/game_over1.png" alt="Story Image" style="max-width:100%;margin-bottom:1em;"><br>
                The map was bold, dramatic—just like the others. Leona typed her commentary without hesitation, echoing the same lines she’d learned to use: strength, division, vigilance. She didn’t question the scale, or why some countries seemed stretched while others shrank. She filed her text, straightened her desk, and waited for the next assignment. The maps kept coming, and Leona kept writing—never realizing that she’d become part of the message.`;
                isFailure = true;
            }
        } else {
            const story = maps[currentMapIndex].story || "No story for this map.";
            typewriterEffect(storyText, story, function() {
                // Optionally do something when finished
});
        }

        // Show the modal
        storyModal.style.display = 'flex';

            // If failure, hook into the modal close to show failure screen
        if (isFailure) {
            // Override closeModal for this case
            const originalCloseModal = closeModal;
            closeModal = function() {
                storyModal.style.display = 'none';
                document.getElementById('failureModal').style.display = 'flex';
                // Restore closeModal for future use
                closeModal = originalCloseModal;
            };
        }
    
    }

    function closeModal() {
        const storyModal = document.getElementById('storyModal');
        storyModal.style.display = 'none';

        // Show choices and map again if still in part1 and not finished
        if (document.getElementById('part1').style.display !== 'none' && currentMapIndex < maps.length - 1) {
            document.querySelector('.choices').style.display = 'block';
            document.querySelector('.map-container').style.display = 'block';
            currentMapIndex++;
            updateMap();
        } else {
            // End of Part 1, proceed to Part 2
            document.getElementById('part1').style.display = 'none';
            document.getElementById('suspicionBarContainer').style.display = 'none';
            document.getElementById('part2').style.display = 'block';
            showPart2IntroPopup();
        }
    }

    function selectMapPart(area, description) {
        if (description) {
            showOverlayDescription(description, function() {
                currentMapIndex++;
                const principle = activePrinciples[currentPrincipleIndex];
                const maps = mapsPerPrinciple[principle];
                if (currentMapIndex >= maps.length) {
                    // Finished all maps for this principle, show story input
                    showPrincipleStoryInput(principle, function(reflection) {
                        if (!completedPrinciples.includes(principle)) {
                            completedPrinciples.push(principle);
                            updatePrincipleBadges();
                        }
                        currentPrincipleIndex++;
                        currentMapIndex = 0;
                        loadPrincipleStage();
                    });
                } else {
                    loadPrincipleStage();
                }
            });
        } else {
            showOverlayDescription("No description available for this area.", function() {
                currentMapIndex++;
                const principle = activePrinciples[currentPrincipleIndex];
                const maps = mapsPerPrinciple[principle];
                if (currentMapIndex >= maps.length) {
                    showPrincipleStoryInput(principle, function(reflection) {
                        if (!completedPrinciples.includes(principle)) {
                            completedPrinciples.push(principle);
                            updatePrincipleBadges();
                        }
                        currentPrincipleIndex++;
                        currentMapIndex = 0;
                        loadPrincipleStage();
                    });
                } else {
                    loadPrincipleStage();
                }
            });
        }
    }

    // Highlight words in Part 2
document.getElementById('highlightableText').addEventListener('click', function (event) {
    if (event.target.tagName === 'SPAN') {
        event.target.classList.toggle('highlighted');
        const word = event.target.textContent.replace(/[.,!?]/g, '');

        // Remove previous correct/incorrect classes
        event.target.classList.remove('correct', 'incorrect');

        if (event.target.classList.contains('highlighted')) {
            if (correctPrinciples.includes(word)) {
                event.target.classList.add('correct');
                suspicion += 3;
                showSuspicionChange(+3);
            } else {
                event.target.classList.add('incorrect');
                suspicion -= 2;
                showSuspicionChange(-2);
            }
            selectedWords.push(word);
        } else {
            // Undo suspicion change when unselecting
            if (correctPrinciples.includes(word)) {
                suspicion -= 3;
                showSuspicionChange(-3);
            } else {
                suspicion += 2;
                showSuspicionChange(+2);
            }
            selectedWords = selectedWords.filter(item => item !== word);
        }
        // Clamp suspicion and update bar
        suspicion = Math.max(0, Math.min(suspicionMax, suspicion));
        updateSuspicionBar(15);
    }
});

function finishGame() {
        // Only for Game 2: if suspicion is below 15, show game over and return
    if (suspicion < 15) {
        const failureModal = document.getElementById('failureModal');
        document.getElementById('failureText').innerHTML =
             `<img src="images/game_over1.png" alt="Game Over" style="max-width:180px;display:block;margin:0 auto 1em auto;">
            Leona’s careful reading wasn’t enough. She returned to the office without hope, without clarity—trapped in the logic of her work, blind to the message it carried.
            Caught in the rhythm of deadlines and office routine, she filed each piece with quiet diligence.
            But the deeper forces at work—the visual tricks, the patterns, the framing—slipped past her.
            Without grasping the power of the maps she annotated, she stayed inside the frame others had drawn.
            The world moved on. And she, still at her desk, never saw the full picture.`;
        failureModal.style.display = 'flex';
        return;
    }
    const correctSelections = selectedWords.filter(word => correctPrinciples.includes(word));
    const incorrectSelections = selectedWords.filter(word => !correctPrinciples.includes(word));
    // Remove duplicates for display
    const uniqueCorrect = [...new Set(correctSelections)];
    const uniqueIncorrect = [...new Set(incorrectSelections)];
    const totalCorrect = correctPrinciples.length;
    const numCorrect = uniqueCorrect.length;
    const numIncorrect = uniqueIncorrect.length;

    const scoreText = document.getElementById('scoreText');
    const summaryHtml = `
        <div style="margin-bottom:1em;">
            As Leona turned the final page, the weight of what she had read settled in.<br>
            The distortions, the choices, the quiet manipulations—none of it was accidental.<br>
            For the first time, the maps at <em>The Sentinel</em> seemed less like truth... and more like tools.<br>
            She saw them clearly now—not as windows to the world, but as carefully drawn arguments.<br>
            And with that clarity, the pieces began to fall into place.<br><br>
            She reached for her notebook and began to write:
        </div>
        <ul style="text-align:left;max-width:400px;margin:1em auto;">
            ${uniqueCorrect.map(p => `<li>${p.toLowerCase()}</li>`).join('')}
        </ul>
        ${numIncorrect > 0 ? `
        <p>Incorrect Selections:</p>
        <ul style="text-align:left;max-width:400px;margin:1em auto;">
            ${uniqueIncorrect.map(p => `<li>${p.toLowerCase()}</li>`).join('')}
        </ul>
        ` : ''}
        <div style="margin-bottom:1em;">
            Correct principles selected: ${numCorrect} / ${totalCorrect}<br>
            Incorrect selections: ${numIncorrect}
        </div>
    `;

    if (typeof testmode !== "undefined" && testmode) {
        scoreText.innerHTML = summaryHtml;
    } else {
        typewriterEffect(scoreText, summaryHtml);
    }

    const scoreModal = document.getElementById('scoreModal');
    scoreModal.style.display = 'flex';

    window.hasFinishedPart2 = true;
}

function closeScoreModal() {
    const scoreModal = document.getElementById('scoreModal');
    scoreModal.style.display = 'none';

    // Only allow selection if there are at least 3 correct principles
    const correctSelections = selectedWords.filter(word => correctPrinciples.includes(word));
    const uniqueCorrect = [...new Set(correctSelections)];

    if (uniqueCorrect.length > 3) {
        showPrincipleSelectionModal(uniqueCorrect);
    } else if (uniqueCorrect.length > 0) {
        // Show intro text, then continue automatically
        showPrincipleAutoIntro(uniqueCorrect);
    } else {
        // If not enough, show a message or return to menu
        alert("You need at least 1 correct principle to continue.");
        document.getElementById('menu').style.display = 'block';
    }
}

// Helper for auto-selection intro
function showPrincipleAutoIntro(principles) {
    // Remove any existing modal
    let oldModal = document.getElementById('principleSelectionModal');
    if (oldModal) oldModal.remove();

    const modal = document.createElement('div');
    modal.id = 'principleSelectionModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width:500px;">
            <p>
                Leona ran her finger slowly down the list she had compiled. Each principle revealed a different way maps could shape belief—some subtle, some bold. She knew she couldn’t explore them all at once.<br><br>
                For now, she would focus on the ones that stood out the most.<br><br>
                <strong>Leona will examine these principle${principles.length > 1 ? 's' : ''} more closely:</strong>
           <ul style="text-align:left; margin:1em 0;">
                ${principles.map(p => `<li>${p.toLowerCase()}</li>`).join('')}
            </ul>
            <button id="confirmPrinciplesBtn">OK</button>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = "flex";

    document.getElementById('confirmPrinciplesBtn').onclick = function() {
        activePrinciples = principles;
        modal.remove();
        startPart3();
    };
}

    function loadPrincipleStage() {
        if (currentPrincipleIndex >= activePrinciples.length) {
        // Instead of alert, show the final principle story, then continue with the Two Worlds map
        showFinalPrincipleStory(function() {
            showTwoWorldsPrincipleDiscovery(activePrinciples, function() {
                document.getElementById('part3').style.display = 'none';
                document.getElementById('menu').style.display = 'block';
            });
        });
        updatePrincipleList();
        return;
        }  

        const principle = activePrinciples[currentPrincipleIndex];
        const maps = mapsPerPrinciple[principle];

        const mapElement = document.getElementById('part3Map');
        const mapOverlay = document.getElementById('mapOverlay');
        mapElement.src = maps[currentMapIndex];
        document.getElementById('part3Title').textContent = `Stage: ${principle} (Map ${currentMapIndex + 1} of ${maps.length})`;

        // --- Dynamic overlay logic ---
        // Remove previous overlays
        mapOverlay.innerHTML = "";
        const overlays = mapOverlays[maps[currentMapIndex]];
        if (overlays) {
            overlays.forEach(overlay => {
                const div = document.createElement('div');
                div.className = 'map-overlay-area';
                div.style.top = overlay.top;
                div.style.left = overlay.left;
                div.style.width = overlay.width;
                div.style.height = overlay.height;
                div.onclick = function() {
                    // Remove highlight from all overlays first
                    Array.from(mapOverlay.children).forEach(child => child.classList.remove('overlay-visible'));
                    // Add highlight to this overlay
                    div.classList.add('overlay-visible');
                    selectMapPart(overlay.area, overlay.description);
                };
                mapOverlay.appendChild(div);
            });
        }
        // ----------------------------

        // Add specific logic for the "Two Worlds" map
        if (maps[currentMapIndex] === "maps/Map_Two_Worlds.jpg") {
            alert("For this map, select the principle in the upper-left corner.");
        }
    }

    function nextMap() {
        currentMapIndex++;
        loadPrincipleStage();
    }

    function showPart1IntroPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('part1IntroPopup');
        if (oldPopup) oldPopup.remove();

        // Sections and images
        const sections = [
            {
                text: `<strong>Velgravia, 1961.</strong><br>
                A country caught in the tide of ambition, ideology, and unrest. In the capital, where pastel façades peel under the weight of old grandeur, the people turn to the only source they trust: The Sentinel, the nation's most influential newspaper.`,
                img: "images/country.jpg",
                alt: "Velgravia"
            },
            {
                text: `Its headquarters rises like a relic from a brighter era—part cathedral, part fortress. Narrow staircases twist past marble busts of long-dead editors. Linotype machines hammer like clockwork in the belly of the building. Tea is served precisely at five. It smells of ink, brass, and expectation.`,
                img: "images/headquarter.jpg",
                alt: "Headquarter"
            },
            {
                text: `You are <strong>Leona Mirek</strong>, a young journalist fresh out of university, brimming with idealism, ambition—and a deep, enduring love for maps.`,
                img: "images/character.jpg",
                alt: "Leona Mirek"
            },
            {
                text: `<strong>Editor Kessler</strong><span style="font-size:0.95em;"> (leaning on the doorframe, eyes on his watch):</span><br><br>
                <em>“Mirek. You’ve got the map texts now. Simple stuff—just a few lines beneath the graphics. Keep it sharp, patriotic, and don’t get clever. These maps already tell the story—your job is to help the readers see it the right way.<br><br>
                Don’t wander off into nuance. Stick to the message. It’s not your job to ask why or how—just make it sound clear, certain, and important. Just give them a story they can nod along to over their morning coffee. Clear?<br><br>
                First draft on my desk before five.”</em>`,
                img: "images/boss.jpg",
                alt: "Editor Kessler"
            }
        ];

        let sectionIndex = 0;

        // Create the popup overlay
        const introPopup = document.createElement('div');
        introPopup.id = 'part1IntroPopup';
        introPopup.className = 'modal'; // Use your modal CSS for background
        introPopup.innerHTML = `
            <div class="popup-content">
                <div id="typewriterText"></div>
                <img id="introImage" src="" alt="">
                <button id="nextIntroBtn" style="display:none;">Next</button>
            </div>
        `;
        document.body.appendChild(introPopup);

        const typewriterTarget = document.getElementById('typewriterText');
        const introImage = document.getElementById('introImage');
        const nextBtn = document.getElementById('nextIntroBtn');

        function showSection(idx) {
            let localAbort = false; // Local abort flag for this section

            typewriterTarget.innerHTML = "";
            introImage.classList.remove('visible');
            introImage.classList.add('intro-image-fade');
            introImage.style.display = "none";
            nextBtn.style.display = "none";
            const html = sections[idx].text;
            const img = sections[idx].img;
            const alt = sections[idx].alt;

            // Extract <strong> heading if present
            const strongMatch = html.match(/<strong>(.*?)<\/strong><br\s*\/?>/i);
            let heading = "";
            let restHtml = html;
            if (strongMatch) {
                heading = strongMatch[1];
                restHtml = html.replace(/<strong>.*?<\/strong><br\s*\/?>/i, "");
            }

            // Remove previous click listeners by setting onclick to null
            const popupContent = introPopup.querySelector('.popup-content');
            introPopup.onclick = null;
            introPopup.onclick = function(e) {
                // Only abort if the click is not on the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            // Attach abort handler for this section
            introPopup.onclick = function(e) {
                // Prevent abort if clicking the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            if (testmode) {
                if (heading) {
                    typewriterTarget.innerHTML = `<p><strong>${heading}</strong></p>${restHtml}`;
                } else {
                    typewriterTarget.innerHTML = restHtml;
                }
                introImage.src = img;
                introImage.alt = alt;
                introImage.style.display = "block";
                introImage.classList.remove('intro-image-fade', 'visible');
                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                nextBtn.style.display = "inline-block";
            } else {
                setTimeout(() => {
                    introImage.src = img;
                    introImage.alt = alt;
                    introImage.style.display = "block";
                    void introImage.offsetWidth;
                    introImage.classList.add('visible');

                    setTimeout(() => {
                        if (heading) {
                            typewriterTarget.innerHTML = `<p><strong id="typewriterHeading"></strong></p><span id="typewriterRest"></span>`;
                        } else {
                            typewriterTarget.innerHTML = `<span id="typewriterRest"></span>`;
                        }
                        const headingTarget = document.getElementById('typewriterHeading');
                        const restTarget = document.getElementById('typewriterRest');
                        let i = 0, j = 0;

                        // Remove HTML tags from restHtml for typing, preserve line breaks
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = restHtml;
                        const plainRest = tempDiv.textContent || tempDiv.innerText || "";

                        function typeHeading() {
                            if (localAbort) {
                                if (headingTarget) headingTarget.textContent = heading;
                                typeRest(true);
                                return;
                            }
                            if (heading && i < heading.length) {
                                if (headingTarget) headingTarget.textContent += heading.charAt(i);
                                i++;
                                setTimeout(typeHeading, 30);
                            } else {
                                typeRest();
                            }
                        }

                        function typeRest(forceShow) {
                            if (localAbort || forceShow) {
                                restTarget.innerHTML = restHtml;
                                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                nextBtn.style.display = "inline-block";
                                return;
                            }
                            if (j < plainRest.length) {
                                restTarget.textContent += plainRest.charAt(j);
                                j++;
                                setTimeout(() => typeRest(), 30);
                            } else {
                                restTarget.innerHTML = restHtml;
                                setTimeout(() => {
                                    nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                    nextBtn.style.display = "inline-block";
                                }, 200);
                            }
                        }

                        if (heading) {
                            typeHeading();
                        } else {
                            typeRest();
                        }
                    }, 800);
                }, 50);
            }
        }

        nextBtn.onclick = function() {
            sectionIndex++;
            if (sectionIndex < sections.length) {
                showSection(sectionIndex);
            } else {
                introPopup.remove();
                document.getElementById('part1').style.display = 'block';
                updateMap();
            }
        };

        // Show the first section
        showSection(sectionIndex);

    }

    // Show character image popup after intro
    function showCharacterPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('characterPopup');
        if (oldPopup) oldPopup.remove();

        const characterPopup = document.createElement('div');
        characterPopup.id = 'characterPopup';
        characterPopup.style.position = 'fixed';
        characterPopup.style.top = '0';
        characterPopup.style.left = '0';
        characterPopup.style.width = '100vw';
        characterPopup.style.height = '100vh';
        characterPopup.style.background = 'rgba(0,0,0,0.7)';
        characterPopup.style.display = 'flex';
        characterPopup.style.alignItems = 'center';
        characterPopup.style.justifyContent = 'center';
        characterPopup.style.zIndex = '1000';

        characterPopup.innerHTML = `
            <div class="popup-content" style="background:#fff;max-width:400px;padding:2em;border-radius:10px;box-shadow:0 2px 16px #0008;text-align:center;">
                <img src="images/character.jpg" alt="Leona Mirek" style="max-width:100%;height:auto;border-radius:8px;margin-bottom:1em;">
                <div style="font-family:'Special Elite','Source Sans 3',Arial,sans-serif;font-size:1.2em;margin-bottom:1em;">
                    Leona Mirek, young journalist
                </div>
                <button id="closeCharacterBtn" style="margin-top:1em;">OK</button>
            </div>
        `;
        document.body.appendChild(characterPopup);

        document.getElementById('closeCharacterBtn').onclick = function() {
            characterPopup.remove();
            document.getElementById('part1').style.display = 'block';
            updateMap();
        };
    }

    // When the Part 1 button is pressed:
    document.getElementById('part1Btn').onclick = function() {
        showPart1IntroPopup();
        document.getElementById('part1').style.display = 'none'; // Hide task until intro popup is done
    };

    // In showPart1IntroPopup, after the last popup, just show the task:
    nextBtn.onclick = function() {
        sectionIndex++;
        if (sectionIndex < sections.length) {
            showSection(sectionIndex);
        } else {
            introPopup.remove();
            document.getElementById('part1').style.display = 'block';
            updateMap();
        }
    };

    function showPart1TaskIntroPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('part1TaskIntroPopup');
        if (oldPopup) oldPopup.remove();

        // Create the popup overlay
        const popup = document.createElement('div');
        popup.id = 'part1TaskIntroPopup';
        popup.style.position = 'fixed';
        popup.style.top = '0';
        popup.style.left = '0';
        popup.style.width = '100vw';
        popup.style.height = '100vh';
        popup.style.background = 'rgba(0,0,0,0.7)';
        popup.style.display = 'flex';
        popup.style.alignItems = 'center';
        popup.style.justifyContent = 'center';
        popup.style.zIndex = '1000';
        popup.className = 'modal';
        popup.innerHTML = `
            <div class="popup-content" style="max-width: 500px;">
                <p>
                    <strong>Your editor has assigned you to select the accompanying text for today's published map.</strong>
                </p>
                <p>
                    Choose the statement that best reflects the message <em>The Sentinel</em> wants to convey.<br>
                    Your words must support the newspaper’s perspective—and by extension, the regime’s.
                </p>
                <p>
                    <em>Be clear. Be confident. Be loyal.</em>
                </p>
                <button id="part1TaskIntroOkBtn">OK</button>
            </div>
        `;
        document.body.appendChild(popup);

        document.getElementById('part1TaskIntroOkBtn').onclick = function() {
            popup.remove();
            document.getElementById('part1').style.display = 'block';
            document.getElementById('suspicionBarContainer').style.display = 'block';
            updateSuspicionBar(20); // <-- Marker at 20 for Game 1
            updateMap();
        };
    }

    // Automatically show Part 1 task intro popup after the character popup
    document.getElementById('closeCharacterBtn').onclick = function() {
        showPart1TaskIntroPopup();
    };

function updateSuspicionBar(minSuspicion = null) {
    const bar = document.getElementById('suspicionBar');
    const val = document.getElementById('suspicionValue');
    const percent = Math.round((suspicion / suspicionMax) * 100);

    // The cover overlays the unfilled part of the bar
    bar.innerHTML = `<div class="suspicion-bar-cover" style="left:${percent}%;width:${100 - percent}%;"></div>`;

    val.textContent = `${suspicion} / ${suspicionMax}`;

    // Update the marker
    const marker = document.getElementById('suspicionMarker');
    if (marker) {
        const minValue = minSuspicion !== null ? minSuspicion : 15;
        if (minValue > 0) {
            // Get the actual width of the bar in pixels
            const barWidth = bar.offsetWidth || 110; // fallback to 110px if not rendered yet
            const minPx = (minValue / suspicionMax) * barWidth;
            marker.innerHTML = `
                <div style="
                    position:absolute;
                    left:${minPx - 1}px;
                    top:0;
                    height:100%;
                    width:2px;
                    background:black;
                    z-index:3;
                    pointer-events:none;
                "></div>
            `;
        } else {
            marker.innerHTML = '';
        }
    }
}

function showSuspicionChange(amount) {
    const changeDiv = document.getElementById('suspicionChange');
    if (!changeDiv) return;
    changeDiv.textContent = (amount > 0 ? "+" : "") + amount;
    changeDiv.style.color = amount < 0 ? "#b22222" : "#1a7f1a";
    changeDiv.style.opacity = "1";
    changeDiv.style.transform = "translateY(0px)";
    setTimeout(() => {
        changeDiv.style.opacity = "0";
        changeDiv.style.transform = "translateY(-20px)";
    }, 1200);
}

function returnToMenu() {
    // Hide all game sections and modals
    document.getElementById('failureModal').style.display = 'none';
    document.getElementById('scoreModal').style.display = 'none';
    document.getElementById('storyModal').style.display = 'none';
    document.getElementById('part1').style.display = 'none';
    document.getElementById('part2').style.display = 'none';
    document.getElementById('part3').style.display = 'none';
    document.getElementById('suspicionBarContainer').style.display = 'none';

    // Remove any intro or character popups if present
    const introPopup = document.getElementById('part1IntroPopup');
    if (introPopup) introPopup.remove();
    const characterPopup = document.getElementById('characterPopup');
    if (characterPopup) characterPopup.remove();
    const part1TaskIntroPopup = document.getElementById('part1TaskIntroPopup');
    if (part1TaskIntroPopup) part1TaskIntroPopup.remove();

    const allCollected = correctPrinciples.every(p => completedPrinciples.includes(p));
    if (allCollected && !document.getElementById('thankYouPopup')) {
        document.getElementById('menu').style.display = 'none';
        showThankYouPopup();
        return;
    }

    document.getElementById('menu').style.display = 'block';

    // Reset game state
    currentMapIndex = 0;
    suspicion = 5;
    part1TaskIntroShown = false;
    selectedWords = [];
    activePrinciples = [];
    currentPrincipleIndex = 0;
    isFailure = false;

    // Show "Start Principles Selection" button if player has finished Part 2 at least once
    const startPrinciplesBtn = document.getElementById('startPrinciplesBtn');
    if (startPrinciplesBtn) {
        // You can use a flag in localStorage or a JS variable to track if Part 2 was finished
        if (window.hasFinishedPart2) {
            startPrinciplesBtn.style.display = 'inline-block';
        } else {
            startPrinciplesBtn.style.display = 'none';
        }
    }

    // Reset UI elements
    updateSuspicionBar();
    const result = document.getElementById('result');
    if (result) result.textContent = '';
    const choices = document.querySelector('.choices');
    if (choices) choices.style.display = 'block';
    const mapContainer = document.querySelector('.map-container');
    if (mapContainer) mapContainer.style.display = 'block';

    updatePrincipleBadges();

    /*const allPrinciples = [
        "projection",
        "symbolization",
        "generalization",
        "classification",
        "Scale",
        "Framing and orientation",
        "Labeling and text placement",
        "colour"
    ];*/

}

// Map image enlarge popup logic
document.addEventListener('DOMContentLoaded', function() {
    const mapImg = document.getElementById('map');
    const imagePopup = document.getElementById('imagePopup');
    const popupImg = document.getElementById('popupImg');

    if (mapImg && imagePopup && popupImg) {
        mapImg.style.cursor = "zoom-in";
        mapImg.addEventListener('click', function() {
            popupImg.src = mapImg.src;
            imagePopup.style.display = 'flex';
        });

        imagePopup.addEventListener('click', function() {
            imagePopup.style.display = 'none';
            popupImg.src = "";
        });
    }
});

function typewriterEffect(target, html, callback) {
    // Abort any running typewriter
    typewriterAbort = true;

    // If testmode is enabled, show the text instantly (no animation)
    if (typeof testmode !== "undefined" && testmode) {
        target.innerHTML = html;
        if (callback) callback();
        return;
    }

    // Otherwise, animate the text as before
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    const plain = tempDiv.textContent || tempDiv.innerText || "";

    target.textContent = "";
    let i = 0;
    typewriterAbort = false; // Reset abort for this run

    // Try to find the closest modal ancestor, fallback to storyModal for legacy code
    let modal = target.closest('.modal') || document.getElementById('storyModal');
    if (!modal) modal = document.body;

    modal.onclick = function(e) {
        if (!e.target.closest('button')) {
            typewriterAbort = true;
        }
    };

    function type() {
        if (typewriterAbort) {
            target.innerHTML = html;
            if (callback) callback();
            modal.onclick = null;
            return;
        }
        if (i < plain.length) {
            target.textContent += plain.charAt(i);
            i++;
            setTimeout(type, 18);
        } else {
            target.innerHTML = html;
            if (callback) callback();
            modal.onclick = null;
        }
    }
    type();
}

function showPart2IntroPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('part2IntroPopup');
        if (oldPopup) oldPopup.remove();

        // Sections and images
        const sections = [
            {
                text: `The newsroom buzzed with the usual rhythm—keys clacking, phones ringing, editors barking headlines across the room. But Leona barely heard it anymore. She stared at the last map she’d commented on, her fingers frozen above the typewriter keys. Something didn’t sit right. The shapes, the colors, the way the lines always seemed to serve the same story—it wasn’t chance.
                    Without a word, she gathered her coat, slipped the map into her satchel, and walked briskly past the archives, avoiding Kessler’s line of sight. Down the stairwell, out through the side entrance, into the wind.
                    An hour later, she stood beneath the vaulted ceiling of the National Library, surrounded by dust and silence. No editor here to steer the narrative—just shelves and shelves of forgotten truths. She wasn’t sure what she was looking for, but she knew where to begin: the maps.
                    And this time, she’d be the one asking the questions.`,
                img: "images/library.jpg",
                alt: "Library"
            },
            {
                text: `Leona wandered through the dim stacks, her fingers trailing along cracked spines and dust-coated covers. Most titles were dry records—atlases, charts, border archives. She was about to give up when a plain linen book caught her eye.<br><br>
                    <em>“The Language of Maps: Power, Practice, and Perception.”</em><br><br>
                    No author, no markings—just a stamp inside: Restricted, 1930. She opened it carefully. The pages spoke of distortion, symbols, silence, and intent.
                    She leaned against the shelf and kept reading. The maps were starting to make sense—and that frightened her.`,
                img: "images/library_inside.jpg",
                alt: "Library_Inside"
            },
        ];

        let sectionIndex = 0;

        // Create the popup overlay
        const introPopup = document.createElement('div');
        introPopup.id = 'part2IntroPopup';
        introPopup.className = 'modal'; // Use your modal CSS for background
        introPopup.innerHTML = `
            <div class="popup-content">
                <div id="typewriterText"></div>
                <img id="introImage" src="" alt="">
                <button id="nextIntroBtn" style="display:none;">Next</button>
            </div>
        `;
        document.body.appendChild(introPopup);
        introPopup.style.display = "flex";

        const typewriterTarget = document.getElementById('typewriterText');
        const introImage = document.getElementById('introImage');
        const nextBtn = document.getElementById('nextIntroBtn');

        function showSection(idx) {
            let localAbort = false; // Local abort flag for this section

            typewriterTarget.innerHTML = "";
            introImage.classList.remove('visible');
            introImage.classList.add('intro-image-fade');
            introImage.style.display = "none";
            nextBtn.style.display = "none";
            const html = sections[idx].text;
            const img = sections[idx].img;
            const alt = sections[idx].alt;

            // Extract <strong> heading if present
            const strongMatch = html.match(/<strong>(.*?)<\/strong><br\s*\/?>/i);
            let heading = "";
            let restHtml = html;
            if (strongMatch) {
                heading = strongMatch[1];
                restHtml = html.replace(/<strong>.*?<\/strong><br\s*\/?>/i, "");
            }

            // Remove previous click listeners by setting onclick to null
            const popupContent = introPopup.querySelector('.popup-content');
            introPopup.onclick = null;
            introPopup.onclick = function(e) {
                // Only abort if the click is not on the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            // Attach abort handler for this section
            introPopup.onclick = function(e) {
                // Prevent abort if clicking the Next button
                if (!e.target.closest('button')) {
                    localAbort = true;
                }
            };

            if (testmode) {
                if (heading) {
                    typewriterTarget.innerHTML = `<p><strong>${heading}</strong></p>${restHtml}`;
                } else {
                    typewriterTarget.innerHTML = restHtml;
                }
                introImage.src = img;
                introImage.alt = alt;
                introImage.style.display = "block";
                introImage.classList.remove('intro-image-fade', 'visible');
                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                nextBtn.style.display = "inline-block";
            } else {
                setTimeout(() => {
                    introImage.src = img;
                    introImage.alt = alt;
                    introImage.style.display = "block";
                    void introImage.offsetWidth;
                    introImage.classList.add('visible');

                    setTimeout(() => {
                        if (heading) {
                            typewriterTarget.innerHTML = `<p><strong id="typewriterHeading"></strong></p><span id="typewriterRest"></span>`;
                        } else {
                            typewriterTarget.innerHTML = `<span id="typewriterRest"></span>`;
                        }
                        const headingTarget = document.getElementById('typewriterHeading');
                        const restTarget = document.getElementById('typewriterRest');
                        let i = 0, j = 0;

                        // Remove HTML tags from restHtml for typing, preserve line breaks
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = restHtml;
                        const plainRest = tempDiv.textContent || tempDiv.innerText || "";

                        function typeHeading() {
                            if (localAbort) {
                                if (headingTarget) headingTarget.textContent = heading;
                                typeRest(true);
                                return;
                            }
                            if (heading && i < heading.length) {
                                if (headingTarget) headingTarget.textContent += heading.charAt(i);
                                i++;
                                setTimeout(typeHeading, 30);
                            } else {
                                typeRest();
                            }
                        }

                        function typeRest(forceShow) {
                            if (localAbort || forceShow) {
                                restTarget.innerHTML = restHtml;
                                nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                nextBtn.style.display = "inline-block";
                                return;
                            }
                            if (j < plainRest.length) {
                                restTarget.textContent += plainRest.charAt(j);
                                j++;
                                setTimeout(() => typeRest(), 30);
                            } else {
                                restTarget.innerHTML = restHtml;
                                setTimeout(() => {
                                    nextBtn.textContent = (idx < sections.length - 1) ? "Next" : "OK";
                                    nextBtn.style.display = "inline-block";
                                }, 200);
                            }
                        }

                        if (heading) {
                            typeHeading();
                        } else {
                            typeRest();
                        }
                    }, 800);
                }, 50);
            }
        }

        nextBtn.onclick = function() {
            sectionIndex++;
            if (sectionIndex < sections.length) {
                showSection(sectionIndex);
            } else {
                introPopup.remove();
                showPart2TaskIntroPopup(); // Only now show the task message, and only after that show part2
            }
        };

        // Show the first section
        showSection(sectionIndex);

    }

    function showPart2TaskIntroPopup() {
        // Remove any existing popup
        const oldPopup = document.getElementById('part2TaskIntroPopup');
        if (oldPopup) oldPopup.remove();

        // Create the popup overlay
        const popup = document.createElement('div');
        popup.id = 'part2TaskIntroPopup';
        popup.className = 'modal';
        popup.innerHTML = `
            <div class="popup-content" style="max-width: 500px;">
                <p>
                    Leona had discovered an old book tucked away in the restricted section of the library.
                    <br>
                    Its pages explored how maps could shape perception and influence belief. Hidden throughout the text were key cartographic principles—subtle techniques used to guide interpretation and support a message.
                    <br><br>
                    <em>Help Leona read carefully. Click on the concepts that revealed the mapmaker’s tools.</em>
                </p>
                <button id="part2TaskIntroOkBtn">OK</button>
            </div> 
        `;
        document.body.appendChild(popup);
        popup.style.display = "flex";

        document.getElementById('part2TaskIntroOkBtn').onclick = function() {
            popup.remove();
            document.getElementById('part2').style.display = 'block'; // Only now show the text
            document.getElementById('suspicionBarContainer').style.display = 'block'; // Show suspicion bar
            updateSuspicionBar(15);
        };
    }

    function showPrincipleSelectionModal(correctPrinciplesSelected) {
    // Remove any existing modal
    let oldModal = document.getElementById('principleSelectionModal');
    if (oldModal) oldModal.remove();

    // Create modal
    const modal = document.createElement('div');
    modal.id = 'principleSelectionModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width:500px;">
            <p>
                Leona ran her finger slowly down the list she had compiled. Each principle revealed a different way maps could shape belief—some subtle, some bold. She knew she couldn’t explore them all at once.<br><br>
                For now, she would focus on the ones that stood out the most.<br><br>
                <strong>Select three principles Leona will examine more closely.</strong>
            </p>
            <form id="principleSelectionForm" style="text-align:left; margin:1em 0;">
                ${correctPrinciplesSelected.map((p, i) => `
                    <label style="display:block; margin-bottom:0.5em;">
                        <input type="checkbox" name="principle" value="${p}"> ${p}
                    </label>
                `).join('')}
            </form>
            <button id="confirmPrinciplesBtn" disabled>Confirm Selection</button>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = "flex";

    // Checkbox logic: enable button only if 3 are checked
    const form = document.getElementById('principleSelectionForm');
    const btn = document.getElementById('confirmPrinciplesBtn');
    form.addEventListener('change', function() {
        const checked = form.querySelectorAll('input[type="checkbox"]:checked');
        btn.disabled = checked.length !== 3;
    });

    btn.onclick = function() {
        const checked = Array.from(form.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        // Save the selected principles for the next stage
        activePrinciples = checked;
        modal.remove();
        startPart3();
    };
}

// Show overlay description in a modal popup with typewriter effect
function showOverlayDescription(description, callback) {
    // Remove any existing popup
    let oldPopup = document.getElementById('overlayDescriptionPopup');
    if (oldPopup) oldPopup.remove();

    // Create the popup overlay
    const popup = document.createElement('div');
    popup.id = 'overlayDescriptionPopup';
    popup.className = '';
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.zIndex = '3000';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.background = 'none'; // No background
    popup.innerHTML = `
        <div class="popup-content" style="max-width: 500px;">
            <div id="overlayDescriptionHeading" style="font-weight:bold;margin-bottom:0.5em;"></div>
            <div id="overlayDescriptionText"></div>
            <button id="overlayDescriptionOkBtn" style="display:none;">OK</button>
        </div>
    `;
    document.body.appendChild(popup);

const headingTarget = document.getElementById('overlayDescriptionHeading');
const textTarget = document.getElementById('overlayDescriptionText');
const okBtn = document.getElementById('overlayDescriptionOkBtn');

// Split the input into heading and description
let heading = "";
let descriptionHtml = description;
const strongMatch = description.match(/^<strong>(.*?)<\/strong><br\s*\/?>/i);
if (strongMatch) {
    heading = strongMatch[1];
    descriptionHtml = description.replace(/^<strong>.*?<\/strong><br\s*\/?>/i, "");
}

if (typeof testmode !== "undefined" && testmode) {
    headingTarget.textContent = heading;
    textTarget.innerHTML = descriptionHtml;
    okBtn.style.display = "inline-block";
} else {
    let localAbort = false;
    popup.onclick = function(e) {
        if (!e.target.closest('button')) {
            localAbort = true;
        }
    };

    // Typewriter for heading, then for description
    function typeHeading(i = 0) {
        if (localAbort) {
            headingTarget.textContent = heading;
            typeDescription(true);
            return;
        }
        if (i < heading.length) {
            headingTarget.textContent += heading.charAt(i);
            setTimeout(() => typeHeading(i + 1), 24);
        } else {
            typeDescription();
        }
    }

    function typeDescription(forceShow = false, j = 0) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = descriptionHtml;
        const plain = tempDiv.textContent || tempDiv.innerText || "";
        if (forceShow) {
            textTarget.innerHTML = descriptionHtml;
            okBtn.style.display = "inline-block";
            popup.onclick = null;
            return;
        }
        if (j < plain.length) {
            textTarget.textContent += plain.charAt(j);
            setTimeout(() => typeDescription(false, j + 1), 18);
        } else {
            textTarget.innerHTML = descriptionHtml;
            okBtn.style.display = "inline-block";
            popup.onclick = null;
        }
    }

    headingTarget.textContent = "";
    textTarget.textContent = "";
    typeHeading();
}

    okBtn.onclick = function() {
        popup.remove();
        if (callback) callback();
    };
}

function showPrincipleStoryInput(principle, onContinue) {
    // Remove any existing popup
    let oldPopup = document.getElementById('principleStoryInputPopup');
    if (oldPopup) oldPopup.remove();

    // Get the story snippet for this principle, or a default
    const story = principleStorySnippets[principle] ||
        "How did the maps use this principle to shape meaning? What stood out to you?";

    const popup = document.createElement('div');
    popup.id = 'principleStoryInputPopup';
    popup.className = '';
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.zIndex = '3000';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.background = 'none';
    popup.innerHTML = `
        <div class="popup-content" style="max-width: 500px;">
            <div style="margin-bottom:1em;">
                <strong>${principle}:</strong><br>
                <span style="font-size:0.95em;" id="principleStoryText"></span>
            </div>
            <button id="principleStoryContinueBtn">Continue</button>
        </div>
    `;
    document.body.appendChild(popup);

    // Use typewriter effect with abort support
    const storyTarget = document.getElementById('principleStoryText');
    let localAbort = false;
    popup.onclick = function(e) {
        if (!e.target.closest('button')) {
            localAbort = true;
        }
    };

    if (typeof testmode !== "undefined" && testmode) {
        storyTarget.innerHTML = story;
    } else {
        // Typewriter effect with abort
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = story;
        const plain = tempDiv.textContent || tempDiv.innerText || "";
        storyTarget.textContent = "";
        let i = 0;

        function type() {
            if (localAbort) {
                storyTarget.innerHTML = story;
                popup.onclick = null;
                return;
            }
            if (i < plain.length) {
                storyTarget.textContent += plain.charAt(i);
                i++;
                setTimeout(type, 18);
            } else {
                storyTarget.innerHTML = story;
                popup.onclick = null;
            }
        }
        type();
    }

    document.getElementById('principleStoryContinueBtn').onclick = function() {
        popup.remove();
        if (onContinue) onContinue();
    };
}

function showFinalPrincipleStory(callback) {
    // Remove any existing popup
    let oldPopup = document.getElementById('finalPrincipleStoryPopup');
    if (oldPopup) oldPopup.remove();

    const story = `
        Leona closed the last book with a quiet thud, her fingers briefly resting on its worn cover. The library's silence had become familiar, almost comforting—but her time there was done. She stood, tucked the notes into her coat pocket, and stepped back into the gray light of the afternoon.
        Back at the office, the murmur of typewriters and distant voices returned. She sat down, the same map lying on her desk: Two Worlds. It had confused her before—seemed so blunt, so loud. But now, her eyes scanned differently. The projection, the colors, the rigid divisions—they weren’t just design choices. They were arguments.
        She leaned in, slowly, and for the first time, she saw what the map was trying to say. And what it was trying to hide.
    `;

    const popup = document.createElement('div');
    popup.id = 'finalPrincipleStoryPopup';
    popup.className = '';
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.zIndex = '3000';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.background = 'none';
    popup.innerHTML = `
        <div class="popup-content" style="max-width: 500px; text-align: center;">
            <img src="images/backinoffice.jpg" alt="Back in the office" style="max-width:220px;border-radius:8px;margin-bottom:1em;">
            <div id="finalPrincipleStoryText" style="margin-bottom:1em;"></div>
            <button id="finalPrincipleStoryContinueBtn" style="display:none;">Finish</button>
        </div>
    `;
    document.body.appendChild(popup);

    const storyTarget = document.getElementById('finalPrincipleStoryText');
    const finishBtn = document.getElementById('finalPrincipleStoryContinueBtn');

    if (typeof testmode !== "undefined" && testmode) {
        storyTarget.innerHTML = story;
        finishBtn.style.display = "inline-block";
    } else {
        let localAbort = false;
        popup.onclick = function(e) {
            if (!e.target.closest('button')) {
                localAbort = true;
            }
        };

        // Typewriter effect with abort support
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = story;
        const plain = tempDiv.textContent || tempDiv.innerText || "";
        storyTarget.textContent = "";
        let i = 0;

        function type() {
            if (localAbort) {
                storyTarget.innerHTML = story;
                finishBtn.style.display = "inline-block";
                popup.onclick = null;
                return;
            }
            if (i < plain.length) {
                storyTarget.textContent += plain.charAt(i);
                i++;
                setTimeout(type, 18);
            } else {
                storyTarget.innerHTML = story;
                finishBtn.style.display = "inline-block";
                popup.onclick = null;
            }
        }
        type();
    }

    finishBtn.onclick = function() {
        popup.remove();
        if (callback) callback();
    };
}

function showTwoWorldsPrincipleDiscovery(activePrinciples, onFinish) {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('part3').style.display = 'block';

    const mapElement = document.getElementById('part3Map');
    mapElement.src = "maps/Map_Two Worlds_lowerQuality.png";
    document.getElementById('part3Title').textContent = `Final Challenge: Find All Principles`;

    const mapOverlay = document.getElementById('mapOverlay');
    mapOverlay.innerHTML = "";

    // Only overlays for activePrinciples
    const overlaysToShow = twoWorldsMapOverlays.filter(overlay =>
        activePrinciples.includes(overlay.principle)
    );

    // Track found principles
    let foundPrinciples = new Set();
    updatePrincipleList(foundPrinciples);

    overlaysToShow.forEach((overlay) => {
        const div = document.createElement('div');
        div.className = 'map-overlay-area';
        div.style.top = overlay.top;
        div.style.left = overlay.left;
        div.style.width = overlay.width;
        div.style.height = overlay.height;

        div.onclick = function(e) {
            if (div.classList.contains('overlay-visible')) return; // Already found, do nothing
            div.classList.add('overlay-visible');
            div.style.pointerEvents = "none"; // Make this overlay unclickable after selection
            foundPrinciples.add(overlay.principle);

            // Update the principle list to mark found
            updatePrincipleList(foundPrinciples);

            showOverlayDescription(
                `<strong>${overlay.principle}</strong><br>${overlay.description}`,
                function() {
                    if (foundPrinciples.size === activePrinciples.length) {
                        showFinalDiscoveryPopup(onFinish);
                    }
                }
            );
            e.stopPropagation();
        };
        mapOverlay.appendChild(div);
    });
}

// Show a popup when all principles are found
function showFinalDiscoveryPopup(callback) {
    let oldPopup = document.getElementById('finalDiscoveryPopup');
    if (oldPopup) oldPopup.remove();

    const popup = document.createElement('div');
    popup.id = 'finalDiscoveryPopup';
    popup.className = '';
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.zIndex = '3000';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.background = 'none';
    popup.innerHTML = `
        <div class="popup-content" style="max-width: 500px;">
            <div style="margin-bottom:1em;">
                <strong>Congratulations!</strong><br>
                You have found all the principles on the map.<br>
                Leona finally sees the full picture.
            </div>
            <button id="finalDiscoveryOkBtn">Finish</button>
        </div>
    `;
    document.body.appendChild(popup);

    document.getElementById('finalDiscoveryOkBtn').onclick = function() {
        popup.remove();
        showLeonaConfrontsBoss(function() {
            document.getElementById('part3').style.display = 'none';
            document.getElementById('menu').style.display = 'block';
                // Add all activePrinciples to completedPrinciples
            activePrinciples.forEach(p => {
                if (!completedPrinciples.includes(p)) {
                    completedPrinciples.push(p);
                }
            });
            updatePrincipleBadges();
        });
    };
}
function updatePrincipleList(foundPrinciples = new Set()) {
    const listDiv = document.getElementById('principleList');
    if (!listDiv) return;
    if (activePrinciples && activePrinciples.length > 0) {
        listDiv.innerHTML = activePrinciples.map(p =>
            `<span class="principle-tag${foundPrinciples.has(p) ? ' principle-found' : ''}">
                ${p}${foundPrinciples.has(p) ? ' &#10003;' : ''}
            </span>`
        ).join(' ');
    } else {
        listDiv.innerHTML = '';
    }
}

function showLeonaConfrontsBoss(callback) {
    // Remove any existing popup
    let oldPopup = document.getElementById('leonaBossPopup');
    if (oldPopup) oldPopup.remove();

    const story = `
        Leona stood in the center of the editor’s office, the final map still fresh in her mind. The hammer and sickle loomed across Eurasia in her memory—not just as a threat, but as a construction. A deliberate choice. A symbol wielded like a weapon.
        “I’ve finished reviewing the full set,” she said calmly, her voice carrying a quiet defiance. “Every curve, every label, every splash of red—these aren’t just maps. They’re stories shaped to make people feel surrounded, afraid, obedient. It’s not analysis—it’s choreography.”
        The editor didn’t look up from his desk. “Your job wasn’t to question the message. It was to sharpen it.”
        “But that’s the problem,” Leona replied. “We’re not mapping the world—we’re building cages in people’s minds.”
        He sighed. “So you’ve made your choice.”
        “Yes,” she said, standing straighter. “I’m done helping draw borders that were never meant to be crossed.”
        “You’re dismissed. Effective immediately.”
        The words stung less than she expected. As she left the building, she didn’t look back. The city outside hadn’t changed—but she had. Each line on those maps, each color-coded lie, had taught her not just how persuasion worked—but how to resist it.
        And now, for the first time, she knew exactly which side of the line she stood on.
        `;

    const popup = document.createElement('div');
    popup.id = 'leonaBossPopup';
    popup.className = '';
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.zIndex = '3000';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.background = 'none';
    popup.innerHTML = `
        <div class="popup-content" style="max-width: 500px; text-align: center;">
            <img src="images/confrontation.jpg" alt="Leona confronts boss" style="max-width:220px;border-radius:8px;margin-bottom:1em;">
            <div id="leonaBossStoryText" style="margin-bottom:1em;"></div>
            <button id="leonaBossFinishBtn" style="display:none;">Finish Game</button>
        </div>
    `;
    document.body.appendChild(popup);

    const storyTarget = document.getElementById('leonaBossStoryText');
    const finishBtn = document.getElementById('leonaBossFinishBtn');

    if (typeof testmode !== "undefined" && testmode) {
        storyTarget.innerHTML = story;
        finishBtn.style.display = "inline-block";
    } else {
        let localAbort = false;
        popup.onclick = function(e) {
            if (!e.target.closest('button')) {
                localAbort = true;
            }
        };

        // Typewriter effect with abort support
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = story;
        const plain = tempDiv.textContent || tempDiv.innerText || "";
        storyTarget.textContent = "";
        let i = 0;

        function type() {
            if (localAbort) {
                storyTarget.innerHTML = story;
                finishBtn.style.display = "inline-block";
                popup.onclick = null;
                return;
            }
            if (i < plain.length) {
                storyTarget.textContent += plain.charAt(i);
                i++;
                setTimeout(type, 18);
            } else {
                storyTarget.innerHTML = story;
                finishBtn.style.display = "inline-block";
                popup.onclick = null;
            }
        }
        type();
    }

   finishBtn.onclick = function() {
        popup.remove();
        // Mark that the player finished the full run
        window.hasFinishedPart2 = true;
        localStorage.setItem('hasFinishedPart2', 'true');
        // Show the rerun button on the menu
        const startPrinciplesBtn = document.getElementById('startPrinciplesBtn');
        if (startPrinciplesBtn) startPrinciplesBtn.style.display = 'inline-block';
        if (callback) callback();
    };
}

function updatePrincipleBadges() {
    const badgeDiv = document.getElementById('principleBadges');
    if (!badgeDiv) return;

    // List of all possible principles (in the order you want to show them)
    const allPrinciples = [
        "projection",
        "symbolization",
        "generalization",
        "classification",
        "Scale",
        "Framing and orientation",
        "Labeling and text placement",
        "colour"
    ];

    badgeDiv.innerHTML = allPrinciples.map(p =>
        completedPrinciples.includes(p)
            ? (principlesBadges[p]
                ? `<img class="principle-badge-img" src="${principlesBadges[p]}" alt="${p}" title="${p}">`
                : `<span class="principle-badge">${p}</span>`)
            : `<span class="principle-badge-locked" title="Locked"><img src="badges/lock.png" alt="Locked" style="width:32px;height:32px;opacity:0.5;vertical-align:middle;"></span>`
    ).join(' ');

    // Show or hide the ending button
    const showThankYouBtn = document.getElementById('showThankYouBtn');
    if (showThankYouBtn) {
        const allCollected = allPrinciples.every(p => completedPrinciples.includes(p));
        showThankYouBtn.style.display = allCollected ? "inline-block" : "none";
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updatePrincipleBadges();

    const startBtn = document.getElementById('startGameBtn');
    if (startBtn) {
        startBtn.onclick = handleStartGame;
    }

    const titleScreen = document.getElementById('titleScreen');
    const menu = document.getElementById('menu');
    if (titleScreen && menu && startBtn) {
        startBtn.onclick = function(e) {
            e.stopPropagation();
            // Hide the title screen completely
            titleScreen.style.display = 'none';
            // Optionally, remove the title screen from the DOM for good measure:
            // titleScreen.parentNode.removeChild(titleScreen);

            // Hide any overlays or modals that might be open (defensive)
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // if you use such a class

            // Show the menu
            menu.style.display = 'block';

            // Reset and update badges/menu state
            returnToMenu();
        };

    const showThankYouBtn = document.getElementById('showThankYouBtn');
    if (showThankYouBtn) {
        showThankYouBtn.onclick = showThankYouPopup;
    }
    }


    const resetBtn = document.getElementById('resetGameBtn');
    if (resetBtn) {
        resetBtn.onclick = function(e) {
            e.stopPropagation();
            resetGame();
        };
    }

    // Add click listener to the map image
    const mapImg = document.getElementById('map');
    if (mapImg) {
        mapImg.onclick = function() {
            showPart2IntroPopup();
        };
    }

    const optionsBtn = document.getElementById('optionsBtn');
    const optionsMenu = document.getElementById('optionsMenu');
    const closeOptionsBtn = document.getElementById('closeOptionsBtn');

    if (optionsBtn && optionsMenu) {
        optionsBtn.onclick = function() {
            optionsMenu.style.display = optionsMenu.style.display === 'none' ? 'block' : 'none';
        };
    }
    if (closeOptionsBtn && optionsMenu) {
        closeOptionsBtn.onclick = function() {
            optionsMenu.style.display = 'none';
        };
    }

    const startPrinciplesBtn = document.getElementById('startPrinciplesBtn');
    if (startPrinciplesBtn) {
        startPrinciplesBtn.onclick = function() {
            startPart3();
        };
    }
});

function handleStartGame() {
    // Hide the title screen completely
    const titleScreen = document.getElementById('titleScreen');
    if (titleScreen) titleScreen.style.display = 'none';

    // Hide any overlays or modals that might be open (defensive)
    document.body.style.overflow = '';
    document.body.classList.remove('modal-open');

    // Show the menu and reset/update state
    returnToMenu();
}

function showThankYouPopup() {
    // Remove any existing popup
    let oldPopup = document.getElementById('thankYouPopup');
    if (oldPopup) oldPopup.remove();

    const popup = document.createElement('div');
    popup.id = 'thankYouPopup';
    popup.className = 'modal';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.position = 'fixed';
    popup.style.top = '0';
    popup.style.left = '0';
    popup.style.width = '100vw';
    popup.style.height = '100vh';
    popup.style.zIndex = '5000';
    popup.style.background = 'rgba(0,0,0,0.7)';
    popup.innerHTML = `
        <div class="popup-content" style="max-width: 500px; text-align: center;">
            <img src="images/gamefinish.png" alt="Leona thanks you" style="max-width:220px;border-radius:8px;margin-bottom:1em;">
            <h2>You did it. We did it.</h2>
            <div id="thankYouText" style="margin-bottom:1em;min-height:120px;"></div>
            <button id="thankYouOkBtn" style="display:none;">OK</button>
        </div>
    `;
    document.body.appendChild(popup);

    const text = `
        Leona looks up from the last map, the badges glowing softly on the wall behind her.<br><br>
        "Each one of these... you helped me see what I couldn't before. The way maps speak, persuade, and control.<br>
        Thank you for walking this path with me.<br>
        Now I know how to read between the lines—and more importantly, how to resist."<br><br>
        She smiles.<br>
        "The world is still divided. But thanks to you, I'm not blind to it anymore."
    `;

    const textTarget = document.getElementById('thankYouText');
    const okBtn = document.getElementById('thankYouOkBtn');

    // Use your typewriter effect
    typewriterEffect(textTarget, text, function() {
        okBtn.style.display = "inline-block";
    });

    okBtn.onclick = function() {
        popup.remove();
    };
}

function showOptionsPopup() {
    // Remove any existing popup
    let oldPopup = document.getElementById('optionsPopup');
    if (oldPopup) oldPopup.remove();

    // Create the popup overlay
    const popup = document.createElement('div');
    popup.id = 'optionsPopup';
    popup.className = 'modal';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.position = 'fixed';
    popup.style.top = '0';
    popup.style.left = '0';
    popup.style.width = '100vw';
    popup.style.height = '100vh';
    popup.style.zIndex = '5000';
    popup.style.background = 'rgba(0,0,0,0.7)';
    popup.innerHTML = `
        <div class="popup-content" style="max-width: 400px;">
            <h3>Options</h3>
            <label style="display:block; margin-bottom:0.5em;">
                <input type="checkbox" id="testmodeCheckboxPopup" ${testmode ? 'checked' : ''}/>
                Testmode (skip animations)
            </label>
            <button id="optStartPart2Btn">Start Part 2: Text Selection</button>
            <button id="optStartPart3Btn">Start Part 3: Principles</button>
            <button id="optStartPart4Btn">Start Part 4: Two Worlds Principle Discovery</button>
            <button id="optThankYouBtn">Start Thank You</button>
            <button id="closeOptionsPopupBtn" style="margin-top:1em;">Close Options</button>
        </div>
    `;
    document.body.appendChild(popup);

    // Sync testmode checkbox
    const testmodeCheckbox = document.getElementById('testmodeCheckboxPopup');
    if (testmodeCheckbox) {
        testmodeCheckbox.checked = testmode;
        testmodeCheckbox.onchange = function() {
            testmode = testmodeCheckbox.checked;
            // Also sync the main menu checkbox if present
            const mainCheckbox = document.getElementById('testmodeCheckbox');
            if (mainCheckbox) mainCheckbox.checked = testmode;
        };
    }

    document.getElementById('closeOptionsPopupBtn').onclick = function() {
        popup.remove();
    };

    document.getElementById('optStartPart2Btn').onclick = function() {
        popup.remove();
        startPart2();
    };
    document.getElementById('optStartPart3Btn').onclick = function() {
        popup.remove();
        startPart3();
    };
    document.getElementById('optStartPart4Btn').onclick = function() {
        popup.remove();
        startPart4();
    };
    document.getElementById('optThankYouBtn').onclick = function() {
        popup.remove();
        showThankYouPopup();
    };
}

// On page load
if (localStorage.getItem('hasFinishedPart2') === 'true') {
    const startPrinciplesBtn = document.getElementById('startPrinciplesBtn');
    if (startPrinciplesBtn) startPrinciplesBtn.style.display = 'inline-block';
    window.hasFinishedPart2 = true;
}

</script>
</body>
</html>